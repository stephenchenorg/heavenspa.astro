---
import type { PageMeta } from '@/types'
import { getCompanySetting } from '@/api/companySetting'
import FloatingContactSidebar from '@/components/FloatingContactSidebar.vue'
import BaseLayout from '@/layouts/BaseLayout.astro'
import Footer from '@/layouts/partials/Footer.astro'
import Header from '@/layouts/partials/Header.astro'
import {seoMeta} from "@stephenchenorg/astro/page";
import {getCanonicalUrl} from "@/utils/seoConfig";
import { gql, graphQLAPI } from '@/api'
import type { PageResponse } from '@/types'

const companySetting = await getCompanySetting()

// 查詢 key="index" 的頁面作為 SEO fallback
const indexPageData = await graphQLAPI<PageResponse>(gql`
  query IndexPageSEO {
    page(key: "index") {
      seo_head
      seo_body
      seo_json_ld
    }
  }
`)

interface Props {
  // metadata
  meta?: PageMeta

  // layout props
  // ...
}

const { meta: pageMeta } = Astro.props

const meta = {
  ...seoMeta({
    title: pageMeta?.seo_title || companySetting.seo_title,
    seo_description: pageMeta?.seo_description || companySetting.seo_description,
    seo_keyword: pageMeta?.seo_keyword || companySetting.seo_keyword,
    og_title: pageMeta?.og_title || companySetting.og_title,
    og_description: pageMeta?.og_description || companySetting.og_description,
    og_image: pageMeta?.og_image || companySetting.og_image,
    // 後台額外欄位 (有值才顯示) - fallback 到 index 頁面的 SEO 設定
    seo_head: pageMeta?.seo_head || indexPageData.page?.seo_head,
    seo_body: pageMeta?.seo_body || indexPageData.page?.seo_body,
    seo_json_ld: pageMeta?.seo_json_ld || indexPageData.page?.seo_json_ld,
  }),
  ...pageMeta,
} as PageMeta

---

<BaseLayout meta={meta}>
  <div class="w-full bg-theme-bg text-theme-text">
    <Header companySetting={companySetting} />

    <slot />

    <Footer companySetting={companySetting} />

    <FloatingContactSidebar
      client:load
      companySetting={companySetting}
    />
  </div>

  <!-- Theme Controller -->
  <!--<ThemeController />-->

</BaseLayout>
