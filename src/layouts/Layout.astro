---
import type { PageMeta } from '@/types'
import { getCompanySetting } from '@/api/companySetting'
import FloatingContactSidebar from '@/components/FloatingContactSidebar.vue'
import BaseLayout from '@/layouts/BaseLayout.astro'
import Footer from '@/layouts/partials/Footer.astro'
import Header from '@/layouts/partials/Header.astro'
import {seoMeta} from "@stephenchenorg/astro/page";
import {getCanonicalUrl} from "@/utils/seoConfig";
import { gql, graphQLAPI } from '@/api'
import type { PageResponse } from '@/types'

const companySetting = await getCompanySetting()

// 查詢 key="index" 的頁面作為 SEO fallback
const indexPageData = await graphQLAPI<PageResponse>(gql`
  query IndexPageSEO {
    page(key: "index") {
      seo_title
      seo_description
      seo_keyword
      og_title
      og_description
      og_image
      seo_head
      seo_body
      seo_json_ld
    }
  }
`)

interface Props {
  // metadata
  meta?: PageMeta

  // layout props
  // ...
}

const { meta: pageMeta } = Astro.props

const meta = {
  ...pageMeta,
  ...seoMeta({
    title: pageMeta?.seo_title || indexPageData.page?.seo_title || '享天堂SPA｜台北專業按摩SPA－放鬆身心的專屬體驗',
    seo_description: pageMeta?.seo_description || indexPageData.page?.seo_description || null,
    seo_keyword: pageMeta?.seo_keyword || indexPageData.page?.seo_keyword || null,
    og_title: pageMeta?.og_title || indexPageData.page?.og_title || null,
    og_description: pageMeta?.og_description || indexPageData.page?.og_description || null,
    og_image: pageMeta?.og_image || indexPageData.page?.og_image || null,
    // 後台額外欄位 (有值才顯示) - fallback 到 index 頁面的 SEO 設定
    // 使用明確檢查來處理空字串的情況
    seo_head: {
      ...indexPageData.page?.seo_head,
      ...pageMeta?.seo_head,
    },
    seo_body: {
      ...indexPageData.page?.seo_body,
      ...pageMeta?.seo_body,
    },
    seo_json_ld: {
      ...indexPageData.page?.seo_json_ld,
      ...pageMeta?.seo_json_ld,
    },
  }),
} as PageMeta

---

<BaseLayout meta={meta}>
  <div class="w-full bg-theme-bg text-theme-text">
    <Header companySetting={companySetting} />

    <slot />

    <Footer companySetting={companySetting} />

    <FloatingContactSidebar
      client:load
      companySetting={companySetting}
    />
  </div>

  <!-- Theme Controller -->
  <!--<ThemeController />-->

</BaseLayout>
