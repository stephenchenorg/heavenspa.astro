---
import { gql, graphQLAPI } from '@/api'
import SectionTitle from '@/components/ui/SectionTitle.astro'

// 定義 API 回應的類型
export interface TeamCover {
  desktop: string
  desktop_blur: string
  mobile: string
  mobile_blur: string
}

export interface TeamCategory {
  title: string
}

export interface TeamMember {
  title: string
  category: TeamCategory
  cover: TeamCover
}

export interface TeamsResponse {
  teams: {
    data: TeamMember[]
  }
}

// GraphQL 查詢與錯誤處理
let teamMembers: TeamMember[] = []

try {
  const teamsData: TeamsResponse = await graphQLAPI(gql`
    query MyQuery {
      teams(sort_by: "asc", sort_column: "sort") {
        data {
          cover {
            desktop
            desktop_blur
            mobile
            mobile_blur
          }
          title
          category {
            title
          }
        }
      }
    }
  `)

  teamMembers = teamsData.teams.data || []
} catch (error) {
  console.error('Failed to fetch team data:', error)
  // 如果 API 失敗，提供預設資料
  teamMembers = [
    {
      title: '專業團隊',
      category: { title: '服務專員' },
      cover: {
        desktop: '/images/default-team.jpg',
        desktop_blur: '/images/default-team-blur.jpg',
        mobile: '/images/default-team-mobile.jpg',
        mobile_blur: '/images/default-team-mobile-blur.jpg',
      },
    },
  ]
}
---

<section
  class="relative z-10 w-full min-h-screen flex flex-col justify-center theme-section py-16 px-6 lg:px-20 md:px-8 sm:px-6"
  id="team"
  data-section="team"
  style="background: var(--theme-bg, #ffffff); color: var(--theme-text, #000000)"
>

  <!-- 標題區 -->
  <SectionTitle title="我們的團隊" subtitle="OUR TEAM" />

  <!-- Airbnb 風格卡片網格 -->
  <div class="max-w-7xl mx-auto w-full">
    <!-- 桌面和平板：網格布局 -->
    <div class="hidden sm:grid grid-cols-3 lg:grid-cols-3 md:grid-cols-2 gap-6 lg:gap-5 md:gap-6">
      {teamMembers.map((member, index) => (
        <div class="group cursor-pointer transition-transform duration-300 hover:-translate-y-2">
          <!-- 圖片容器 -->
          <div class="relative w-full aspect-[4/3] rounded-xl overflow-hidden mb-4">
            <!-- 愛心收藏按鈕 -->
            <button class="absolute top-3 right-3 z-10 w-7 h-7 flex items-center justify-center">
              <svg class="w-5 h-5 fill-none stroke-white stroke-2 drop-shadow-lg hover:fill-white transition-all duration-200" viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
              </svg>
            </button>

            <!-- 團隊成員照片 -->
            <picture class="block w-full h-full">
              <source media="(max-width: 768px)" srcset={member.cover.mobile} />
              <img
                src={member.cover.desktop}
                alt={member.title}
                loading="lazy"
                onload="this.style.filter='none'"
                style="filter: blur(5px); transition: filter 0.3s ease;"
                class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
              />
            </picture>

            <!-- 評級標籤 (左下角) -->
            <div class="absolute bottom-3 left-3 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-medium backdrop-blur-sm">
              ⭐ {member.category.title}
            </div>
          </div>

          <!-- 卡片資訊 -->
          <div class="space-y-1">
            <!-- 標題和評分 -->
            <div class="flex items-start justify-between">
              <h3 class="text-base font-semibold text-black leading-tight line-clamp-1 flex-1 mr-2">
                {member.title}
              </h3>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- 手機版：水平滾動布局 -->
    <div class="sm:hidden">
      <div class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide -mx-6 px-6">
        {teamMembers.map((member, index) => (
          <div class="group cursor-pointer transition-transform duration-300 hover:-translate-y-2 flex-shrink-0 w-[300px]">
            <!-- 圖片容器 -->
            <div class="relative w-full aspect-[4/3] rounded-xl overflow-hidden mb-4">
              <!-- 愛心收藏按鈕 -->
              <button class="absolute top-3 right-3 z-10 w-7 h-7 flex items-center justify-center">
                <svg class="w-5 h-5 fill-none stroke-white stroke-2 drop-shadow-lg hover:fill-white transition-all duration-200" viewBox="0 0 24 24">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
                </svg>
              </button>

              <!-- 團隊成員照片 -->
              <picture class="block w-full h-full">
                <source media="(max-width: 768px)" srcset={member.cover.mobile} />
                <img
                  src={member.cover.desktop}
                  alt={member.title}
                  loading="lazy"
                  onload="this.style.filter='none'"
                  style="filter: blur(5px); transition: filter 0.3s ease;"
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                />
              </picture>

              <!-- 評級標籤 (左下角) -->
              <div class="absolute bottom-3 left-3 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-medium backdrop-blur-sm">
                ⭐ {member.category.title}
              </div>
            </div>

            <!-- 卡片資訊 -->
            <div class="space-y-1">
              <!-- 標題和評分 -->
              <div class="flex items-start justify-between">
                <h3 class="text-base font-semibold text-black leading-tight line-clamp-1 flex-1 mr-2">
                  {member.title}
                </h3>
              </div>
            </div>
          </div>
        ))}
      </div>
  </div>

  <!-- 查看更多按鈕 -->
  <div class="mt-12 max-w-7xl mx-auto w-full">
    <button class="px-6 py-3 border rounded-lg font-medium transition-colors duration-200" style="border-color: var(--theme-text); color: var(--theme-text);" onmouseover="this.style.backgroundColor=getComputedStyle(document.documentElement).getPropertyValue('--theme-text'); this.style.color=getComputedStyle(document.documentElement).getPropertyValue('--theme-bg');" onmouseout="this.style.backgroundColor='transparent'; this.style.color=getComputedStyle(document.documentElement).getPropertyValue('--theme-text');">
      顯示更多團隊成員
    </button>
  </div>
</section>
