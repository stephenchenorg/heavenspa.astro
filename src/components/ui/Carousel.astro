---
export interface Props {
  itemCount: number
  autoPlayInterval?: number
  showNavigation?: boolean
  showDots?: boolean
  responsive?: {
    sm: number
    md: number
    lg: number
  }
  uniqueId: string
  containerClass?: string
  slideClass?: string
}

const {
  itemCount,
  autoPlayInterval = 5000,
  showNavigation = true,
  showDots = true,
  responsive = { sm: 1, md: 2, lg: 3 },
  uniqueId,
  containerClass = '',
} = Astro.props
---

<div class={`${uniqueId}-carousel relative overflow-hidden ${containerClass}`}>
  <!-- 輪播容器 -->
  <div class="carousel-track flex transition-transform duration-500 ease-out">
    <slot />
  </div>

  <!-- 輪播指示器 -->
  {showDots && (
    <div class="carousel-dots flex justify-center mt-6 p-4 gap-2">
      <!-- 指示器會由 JavaScript 動態生成 -->
    </div>
  )}

  <!-- 導航按鈕 -->
  {showNavigation && (
    <>
      <button
        class="carousel-prev absolute left-4 w-12 h-12 rounded-full flex items-center justify-center text-white transition-all duration-200 hover:scale-110 active:scale-95 bg-black/60 hover:bg-black/80 backdrop-blur-sm"
        aria-label="上一頁"
        style="top: 50%; transform: translateY(-50%); z-index: 500;"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button
        class="carousel-next absolute right-4 w-12 h-12 rounded-full flex items-center justify-center text-white transition-all duration-200 hover:scale-110 active:scale-95 bg-black/60 hover:bg-black/80 backdrop-blur-sm"
        aria-label="下一頁"
        style="top: 50%; transform: translateY(-50%); z-index: 500;"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </>
  )}
</div>

<script
  is:inline
  define:vars={{
  itemCount,
  autoPlayInterval,
  responsive,
  uniqueId,
  showNavigation,
  showDots,
}}
>
  // 響應式輪播功能
  document.addEventListener('DOMContentLoaded', () => {
    const carousel = document.querySelector(`.${uniqueId}-carousel`)
    if (!carousel) return

    const track = carousel.querySelector('.carousel-track')
    const slides = carousel.querySelectorAll('.carousel-slide')
    const dotsContainer = carousel.querySelector('.carousel-dots')
    const prevBtn = carousel.querySelector('.carousel-prev')
    const nextBtn = carousel.querySelector('.carousel-next')

    if (!track || slides.length <= 1) return

    let currentIndex = 0
    let autoTimer = null

    // 取得目前螢幕大小對應的每頁顯示數量
    function getSlidesPerView() {
      const width = window.innerWidth
      if (width >= 1024) return responsive.lg
      if (width >= 768) return responsive.md
      return responsive.sm
    }

    // 計算總頁數
    function getTotalPages() {
      const slidesPerView = getSlidesPerView()
      return Math.ceil(itemCount / slidesPerView)
    }

    // 創建指示器
    function createDots() {
      if (!showDots || !dotsContainer) return

      const totalPages = getTotalPages()
      
      // 如果總頁數為 0 或 1，隱藏指示器
      if (totalPages <= 1) {
        dotsContainer.innerHTML = ''
        dotsContainer.style.display = 'none'
        return
      }
      
      // 顯示指示器容器
      dotsContainer.style.display = 'flex'
      
      // 只有在數量真的不同時才重新創建
      const currentDots = dotsContainer.querySelectorAll('.carousel-dot')
      if (currentDots.length === totalPages) {
        // 確保所有點都有正確的事件監聽器
        currentDots.forEach((dot, i) => {
          dot.onclick = () => {
            currentIndex = i
            updateCarouselPosition()
            resetAutoSlide()
          }
        })
        return
      }
      
      // 使用 DocumentFragment 避免多次 DOM 操作導致的閃爍
      const fragment = document.createDocumentFragment()
      
      for (let i = 0; i < totalPages; i++) {
        const dot = document.createElement('button')
        dot.className = 'carousel-dot w-3 h-3 rounded-full transition-all duration-300 hover:scale-110 bg-[var(--theme-text)] opacity-30'
        dot.setAttribute('data-slide', i.toString())
        dot.setAttribute('aria-label', `第 ${i + 1} 頁`)

        dot.addEventListener('click', () => {
          currentIndex = i
          updateCarouselPosition()
          resetAutoSlide()
        })

        fragment.appendChild(dot)
      }
      
      // 一次性替換所有內容，減少閃爍
      dotsContainer.innerHTML = ''
      dotsContainer.appendChild(fragment)
    }

    // 更新輪播位置
    function updateCarouselPosition() {
      const slidesPerView = getSlidesPerView()
      const totalPages = getTotalPages()

      // 確保 currentIndex 不超過總頁數
      if (currentIndex >= totalPages) {
        currentIndex = 0
      }

      // 計算位移：每頁移動的距離是 slidesPerView 個 slide 的寬度
      const slideWidth = 100 / slidesPerView
      const translateX = -currentIndex * slideWidth * slidesPerView

      track.style.transform = `translateX(${translateX}%)`

      // 更新指示器
      if (showDots && dotsContainer) {
        const dots = dotsContainer.querySelectorAll('.carousel-dot')
        
        // 確保有指示器點存在且容器是可見的
        if (dots.length > 0 && dotsContainer.style.display !== 'none') {
          // 確保 currentIndex 在有效範圍內
          const safeCurrentIndex = Math.max(0, Math.min(currentIndex, dots.length - 1))
          
          // 調試資訊
          console.log(`Carousel: Updating dots - currentIndex: ${currentIndex}, safeIndex: ${safeCurrentIndex}, totalDots: ${dots.length}`)
          
          dots.forEach((dot, index) => {
            if (index === safeCurrentIndex) {
              dot.style.opacity = '1'
              dot.style.transform = 'scale(1.2)'
              dot.classList.add('active')
            } else {
              dot.style.opacity = '0.3'
              dot.style.transform = 'scale(1)'
              dot.classList.remove('active')
            }
          })
        } else if (dots.length === 0) {
          // 如果點點消失了，重新創建
          console.log('Carousel: Dots disappeared, recreating...')
          createDots()
          // 遞歸調用一次以更新狀態
          setTimeout(() => updateCarouselPosition(), 50)
        }
      }
    }

    // 下一頁
    function nextSlide() {
      const totalPages = getTotalPages()
      if (totalPages > 0) {
        currentIndex = (currentIndex + 1) % totalPages
        updateCarouselPosition()
      }
    }

    // 上一頁
    function prevSlide() {
      const totalPages = getTotalPages()
      if (totalPages > 0) {
        currentIndex = currentIndex === 0 ? totalPages - 1 : currentIndex - 1
        updateCarouselPosition()
      }
    }

    // 自動輪播
    function startAutoSlide() {
      if (autoTimer) clearInterval(autoTimer)
      autoTimer = setInterval(nextSlide, autoPlayInterval)
    }

    function stopAutoSlide() {
      if (autoTimer) {
        clearInterval(autoTimer)
        autoTimer = null
      }
    }

    function resetAutoSlide() {
      stopAutoSlide()
      startAutoSlide()
    }

    // 按鈕事件
    if (showNavigation) {
      nextBtn?.addEventListener('click', () => {
        nextSlide()
        resetAutoSlide()
      })

      prevBtn?.addEventListener('click', () => {
        prevSlide()
        resetAutoSlide()
      })
    }

    // 觸控滑動支援
    let touchStartX = 0
    let touchIsDragging = false

    carousel.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].clientX
      touchIsDragging = true
      stopAutoSlide()
    })

    carousel.addEventListener('touchend', e => {
      if (!touchIsDragging) return

      const touchEndX = e.changedTouches[0].clientX
      const diffX = touchStartX - touchEndX

      if (Math.abs(diffX) > 50) {
        if (diffX > 0) {
          nextSlide()
        } else {
          prevSlide()
        }
      }

      touchIsDragging = false
      startAutoSlide()
    })

    // 更新導航按鈕位置到卡片中心
    function updateButtonPosition() {
      if (!showNavigation) return

      const firstSlide = slides[0]
      if (firstSlide) {
        const slideRect = firstSlide.getBoundingClientRect()
        const carouselRect = carousel.getBoundingClientRect()

        // 計算卡片內容相對於輪播容器的中心位置
        const slideCenter = slideRect.top + slideRect.height / 2 - carouselRect.top

        if (prevBtn && nextBtn) {
          prevBtn.style.top = `${slideCenter}px`
          nextBtn.style.top = `${slideCenter}px`
          prevBtn.style.transform = 'translateY(-50%)'
          nextBtn.style.transform = 'translateY(-50%)'
        }
      }
    }

    // 響應式處理
    function handleResize() {
      const oldTotalPages = dotsContainer ? dotsContainer.children.length : 0
      const newTotalPages = getTotalPages()
      
      // 只有在總頁數真正改變時才重新創建指示器
      if (oldTotalPages !== newTotalPages) {
        // 如果當前索引超過新的總頁數，調整到合適的位置
        if (currentIndex >= newTotalPages) {
          currentIndex = Math.max(0, newTotalPages - 1)
        }
        createDots()
      }
      
      updateCarouselPosition()
      // 延遲更新按鈕位置，確保布局完成
      setTimeout(updateButtonPosition, 100)
    }

    // 初始化
    createDots()
    updateCarouselPosition()
    // 延遲更新按鈕位置，確保布局完成
    setTimeout(updateButtonPosition, 100)
    
    // 定期檢查指示器是否存在（調試用）
    const checkDotsInterval = setInterval(() => {
      if (showDots && dotsContainer) {
        const dots = dotsContainer.querySelectorAll('.carousel-dot')
        const totalPages = getTotalPages()
        
        if (dots.length === 0 && totalPages > 1) {
          console.log('Carousel: Dots missing, recreating...')
          createDots()
          updateCarouselPosition()
        }
      }
    }, 2000) // 每 2 秒檢查一次
    
    // 清理函數（在某些情況下可能需要）
    window.addEventListener('beforeunload', () => {
      clearInterval(checkDotsInterval)
    })

    // 防抖的 resize 處理
    let resizeTimeout
    
    function debouncedResize() {
      clearTimeout(resizeTimeout)
      resizeTimeout = setTimeout(handleResize, 150)
    }
    
    // 監聽視窗大小變化
    window.addEventListener('resize', debouncedResize)

    // 延遲啟動自動輪播
    setTimeout(startAutoSlide, 1000)

    // 滑鼠懸停暫停
    carousel.addEventListener('mouseenter', stopAutoSlide)
    carousel.addEventListener('mouseleave', startAutoSlide)
  })
</script>

<style>
  /* 確保輪播在不同螢幕大小下正確顯示 */
  .carousel-slide {
    box-sizing: border-box;
  }

  /* 指示器容器穩定性 */
  .carousel-dots {
    min-height: 32px; /* 確保即使沒有指示器也有固定高度 */
    transition: opacity 0.3s ease;
    position: relative;
    z-index: 10; /* 確保指示器在最上層 */
  }

  /* 指示器點樣式增強 */
  .carousel-dot {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    will-change: transform, opacity;
    pointer-events: auto; /* 確保點擊事件可以觸發 */
    cursor: pointer;
  }

  /* 活躍指示器樣式 */
  .carousel-dot.active {
    background-color: var(--color-primary-500) !important;
  }

  /* 防止指示器在更新時閃爍 */
  .carousel-dots:empty {
    opacity: 0;
  }
  
  /* 確保指示器容器不會被隱藏 */
  .carousel-dots[style*="display: none"] {
    display: flex !important;
  }
</style>
