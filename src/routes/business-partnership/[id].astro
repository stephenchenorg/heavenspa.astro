---
import type { PageMeta } from '@stephenchenorg/astro/page'
import { seoMeta } from '@stephenchenorg/astro/page'
import { getLocale } from 'i18n:astro'
import { getPartnershipPageData } from '@/api/partnerships'
import Prose from '@/components/ui/Prose.vue'
import Layout from '@/layouts/Layout.astro'
import { createNestedT, getLinkByLocale } from '@/utils/i18n'
import { getCanonicalUrl, getSeoConfig } from '@/utils/seoConfig'

const t = await createNestedT()
const currentLocale = getLocale()
const isEnglish = currentLocale === 'en'
const locale = currentLocale === 'en' ? 'en' : 'zh_TW'
const { id } = Astro.params
if (!id || Number.isNaN(Number(id))) {
    return Astro.rewrite('/404')
}

// 批次查詢異業合作和相關異業合作
const { partnership, relatedPartnerships } = await getPartnershipPageData(id)

// 如果異業合作不存在，導向 404
if (!partnership || !partnership.id) {
    return Astro.rewrite('/404')
}

// 過濾掉當前異業合作
const filteredRelatedPartnerships = relatedPartnerships.filter(relatedPartnership => relatedPartnership.id !== partnership.id)

const coverImage = partnership.cover?.desktop || partnership.cover?.mobile

// 建立 SEO 設定 - 使用 API 資料，沒有則使用預設值
const defaultSeo = getSeoConfig('businessPartnership', locale)

const meta = {
  ...seoMeta({
    title: partnership.seo_title || defaultSeo.seo_title,
    seo_description: partnership.seo_description || defaultSeo.seo_description,
    seo_keyword: partnership.seo_keyword || defaultSeo.seo_keyword,
    og_title: partnership.og_title || defaultSeo.og_title,
    og_description: partnership.og_description || defaultSeo.og_description,
    og_image: partnership.og_image || coverImage || defaultSeo.og_image,
    // 後台額外欄位 (有值才顯示)
    seo_head: partnership.seo_head,
    seo_body: partnership.seo_body,
    seo_json_ld: partnership.seo_json_ld,
  }),
  canonical: getCanonicalUrl(`business-partnership/${id}`, locale),
} as PageMeta
---

<Layout meta={meta}>
    <!-- Hero Banner -->
    <section class="relative aspect-[4/3] sm:aspect-[16/10] md:aspect-[16/9] lg:aspect-[1920/600] overflow-hidden pt-20">
        <div class="absolute inset-0">
            <!-- Mobile Image -->
            <img
              src={partnership.background?.mobile || partnership.background?.desktop}
              alt={partnership.title}
              class="object-cover w-full h-full md:hidden"
              loading="eager"
              fetchpriority="high"
            />
            <!-- Desktop Image -->
            <img
              src={partnership.background?.desktop || partnership.background?.mobile}
              alt={partnership.title}
              class="object-cover w-full h-full hidden md:block"
              loading="eager"
              fetchpriority="high"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-black/10"></div>
        </div>

        <!-- Hero Content Overlay -->
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center text-white px-4 sm:px-6 lg:px-8 flex flex-col justify-center h-full">
                <!-- Main Title - Center -->
                <h1 class={`font-bold leading-tight tracking-wide mb-4 sm:mb-6 lg:mb-8 ${isEnglish ? 'text-[clamp(1.25rem,4vw,2.5rem)]' : 'text-[clamp(1.5rem,5vw,3.75rem)]'}`}>
                    {partnership.title}
                </h1>

                <!-- Meta Information - Below Title -->
                <div class={`flex flex-col sm:flex-row sm:items-center justify-center gap-2 sm:gap-3 lg:gap-4 ${isEnglish ? 'text-xs' : 'text-xs sm:text-sm'}`}>
                    <!-- Date -->
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                            />
                        </svg>
                        <span>{new Date(partnership.started_at || new Date()).toLocaleDateString('zh-TW')}</span>
                    </div>

                    <!-- Author -->
                    {(partnership.author) && (
                            <div class="flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                    />
                                </svg>
                                <span>{partnership.author}</span>
                            </div>
                    )}

                    <!-- Tags -->
                    <div class="flex items-center justify-center space-x-2">
                        {partnership.tags?.map(tag => (
                                <span class="px-3 py-1 text-xs font-medium rounded-full bg-white/20 backdrop-blur-sm border border-white/20">
                                {tag.title}
                            </span>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    </section>
    <main class="section-container-detail" style="background: var(--theme-bg, #ffffff); color: var(--theme-text, #000000);">
        <!-- Main Content Area with Sidebar Layout -->
        <section class="py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <!-- Left Content - 3/5 (60%) -->
                    <div class="lg:col-span-3">
                        <!-- Image Gallery Carousel -->
                        <div class="mb-12">
                            <div class="relative">
                                <!-- Carousel Container -->
                                <div
                                  class="relative aspect-[800/544] overflow-hidden shadow-lg"
                                  style="background: var(--theme-card-bg);"
                                >
                                    <!-- Slides -->
                                    <div class="carousel-track flex transition-transform duration-500 ease-in-out h-full">
                                        {partnership.images && partnership.images.length > 0 ? (
                                            partnership.images.map((imageItem, index) => (
                                                <div class="carousel-slide flex-shrink-0 w-full h-full relative">
                                                    <!-- Mobile Image -->
                                                    <img
                                                      src={imageItem.image.mobile || imageItem.image.desktop}
                                                      alt={`${partnership.title} - Image ${index + 1}`}
                                                      class="w-full h-full object-cover md:hidden"
                                                      loading="lazy"
                                                    />
                                                    <!-- Desktop Image -->
                                                    <img
                                                      src={imageItem.image.desktop || imageItem.image.mobile}
                                                      alt={`${partnership.title} - Image ${index + 1}`}
                                                      class="w-full h-full object-cover hidden md:block"
                                                      loading="lazy"
                                                    />
                                                </div>
                                            ))
                                        )}
                                    </div>

                                    <!-- Navigation Arrows -->
                                    <button
                                      class="carousel-prev absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-colors duration-200"
                                      aria-label="Previous image"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path
                                              stroke-linecap="round"
                                              stroke-linejoin="round"
                                              stroke-width="2"
                                              d="M15 19l-7-7 7-7"
                                            />
                                        </svg>
                                    </button>
                                    <button
                                      class="carousel-next absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 transition-colors duration-200"
                                      aria-label="Next image"
                                    >
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path
                                              stroke-linecap="round"
                                              stroke-linejoin="round"
                                              stroke-width="2"
                                              d="M9 5l7 7-7 7"
                                            />
                                        </svg>
                                    </button>

                                    <!-- Dots Indicator -->
                                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2" id="carousel-dots">
                                        <!-- Dots will be dynamically generated by JavaScript based on slide count -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Partnership Content -->
                        <partnership class="prose prose-lg max-w-none my-8" style="color: var(--theme-text);">
                            <Prose sourceDoc={partnership.content || ''} client:visible />
                        </partnership>

                        <!-- Partnership Navigation -->
                        <div class="mb-8 py-8 border-y" style="border-color: var(--theme-border);">
                            <div class="flex items-center justify-between gap-6">
                                <!-- Previous Partnership -->
                                <div class="flex-1 max-w-sm">
                                    {partnership.prev ? (
                                        <a
                                          href={getLinkByLocale(`/business-partnership/${partnership.prev.id}`)}
                                          class="group flex items-center space-x-3 p-4 rounded-lg transition-all duration-300 hover:shadow-md"
                                          style="background: var(--theme-card-bg); border: 1px solid var(--theme-border);"
                                        >
                                            <svg
                                              class="w-5 h-5 transform group-hover:-translate-x-1 transition-transform duration-300 flex-shrink-0"
                                              style="color: var(--color-primary-500);"
                                              fill="none"
                                              stroke="currentColor"
                                              viewBox="0 0 24 24"
                                            >
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                            </svg>
                                            <div class="flex-1 min-w-0">
                                                <div class={`font-medium mb-1 ${isEnglish ? 'text-xs' : 'text-xs'}`} style="color: var(--color-primary-500);">
                                                    {t('partnerships.navigation.previousPartnership')}
                                                </div>
                                                <div class={`font-medium line-clamp-2 ${isEnglish ? 'text-xs' : 'text-sm'}`} style="color: var(--theme-text);">
                                                    {partnership.prev.title}
                                                </div>
                                            </div>
                                        </a>
                                    ) : (
                                        <div class="p-4 rounded-lg opacity-50" style="background: var(--theme-card-bg); border: 1px solid var(--theme-border);">
                                            <div class="text-xs" style="color: var(--theme-text-secondary);">
                                                {t('partnerships.navigation.noPrevious')}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <!-- Next Partnership -->
                                <div class="flex-1 max-w-sm">
                                    {partnership.next ? (
                                        <a
                                          href={getLinkByLocale(`/business-partnership/${partnership.next.id}`)}
                                          class="group flex items-center space-x-3 p-4 rounded-lg transition-all duration-300 hover:shadow-md text-right"
                                          style="background: var(--theme-card-bg); border: 1px solid var(--theme-border);"
                                        >
                                            <div class="flex-1 min-w-0">
                                                <div class={`font-medium mb-1 ${isEnglish ? 'text-xs' : 'text-xs'}`} style="color: var(--color-primary-500);">
                                                    {t('partnerships.navigation.nextPartnership')}
                                                </div>
                                                <div class={`font-medium line-clamp-2 ${isEnglish ? 'text-xs' : 'text-sm'}`} style="color: var(--theme-text);">
                                                    {partnership.next.title}
                                                </div>
                                            </div>
                                            <svg
                                              class="w-5 h-5 transform group-hover:translate-x-1 transition-transform duration-300 flex-shrink-0"
                                              style="color: var(--color-primary-500);"
                                              fill="none"
                                              stroke="currentColor"
                                              viewBox="0 0 24 24"
                                            >
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                            </svg>
                                        </a>
                                    ) : (
                                        <div class="p-4 rounded-lg opacity-50 text-right" style="background: var(--theme-card-bg); border: 1px solid var(--theme-border);">
                                            <div class="text-xs" style="color: var(--theme-text-secondary);">
                                                {t('partnerships.navigation.noNext')}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar - 2/5 (40%) -->
                    <div class="sticky top-8 space-y-8 lg:col-span-2">
                        <!-- Related Partnerships -->
                        <div>
                            <h3
                              class={`font-semibold mb-4 pb-4 ${isEnglish ? 'text-base' : 'text-lg'}`}
                              style="border-bottom: 1px solid var(--theme-border); color: var(--theme-text);"
                            >
                                {t('partnerships.relatedPartnerships')}</h3>
                            <div class="space-y-4">
                                {filteredRelatedPartnerships.length > 0 ? (
                                    filteredRelatedPartnerships.map(relatedPartnership => (
                                        <a href={getLinkByLocale(`/business-partnership/${relatedPartnership.id}`)} class="block group">
                                            <div class="flex space-x-3">
                                                <div class="w-20 h-15 rounded flex-shrink-0 relative overflow-hidden">
                                                    <!-- Mobile Image -->
                                                    <img
                                                      src={relatedPartnership.cover?.mobile || relatedPartnership.cover?.desktop || 'https://imagefaker.access.mx.com/80x60/d4af37/ffffff/?text=Partnership'}
                                                      alt={relatedPartnership.title}
                                                      class="w-full h-full object-cover md:hidden"
                                                      loading="lazy"
                                                    />
                                                    <!-- Desktop Image -->
                                                    <img
                                                      src={relatedPartnership.cover?.desktop || relatedPartnership.cover?.mobile || 'https://imagefaker.access.mx.com/80x60/d4af37/ffffff/?text=Partnership'}
                                                      alt={relatedPartnership.title}
                                                      class="w-full h-full object-cover hidden md:block"
                                                      loading="lazy"
                                                    />
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <h4
                                                      class={`font-medium line-clamp-2 group-hover:underline ${isEnglish ? 'text-xs' : 'text-sm'}`}
                                                      style="color: var(--theme-text);"
                                                    >
                                                        {relatedPartnership.title}
                                                    </h4>
                                                    <p class="text-xs mt-1" style="color: var(--theme-text-secondary);">
                                                        {new Date(relatedPartnership.started_at).toLocaleDateString('zh-TW')}
                                                    </p>
                                                </div>
                                            </div>
                                        </a>
                                    ))
                                ) : (
                                    <>
                                        <span>{t('partnerships.noRelatedPartnerships')}</span>
                                    </>
                                )}
                            </div>
                        </div>
                        <!-- Tags -->
                        <div>
                            <h3
                              class={`font-semibold mb-4 pb-4 ${isEnglish ? 'text-base' : 'text-lg'}`}
                              style="border-bottom: 1px solid var(--theme-border); color: var(--theme-text);"
                            >
                                {t('partnerships.tags')}</h3>
                            <div class="flex flex-wrap gap-2">
                                {partnership.tags?.map(tag => (
                                    <span
                                      class={`rounded-md px-3 py-2 transition-all duration-200 cursor-pointer border hover:border-primary-500 hover:bg-primary-50 ${isEnglish ? 'text-xs' : 'text-sm'}`}
                                      style="border-color: var(--theme-border); color: var(--theme-text); background: var(--theme-card-bg);"
                                    >
                                        {tag.title}
                                    </span>
                                ))}
                                {(!partnership.tags || partnership.tags.length === 0) && (
                                    <span
                                      class={`rounded-md px-3 py-2 transition-all duration-200 cursor-pointer border hover:border-primary-500 hover:bg-primary-50 ${isEnglish ? 'text-xs' : 'text-sm'}`}
                                      style="border-color: var(--theme-border); color: var(--theme-text); background: var(--theme-card-bg);"
                                    >
                                        {t('partnerships.fallbackTags.beauty')}
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const carouselTrack = document.querySelector('.carousel-track')
            const slides = document.querySelectorAll('.carousel-slide')
            const prevButton = document.querySelector('.carousel-prev') as HTMLElement | null
            const nextButton = document.querySelector('.carousel-next') as HTMLElement | null
            const dotsContainer = document.querySelector('#carousel-dots') as HTMLElement | null

            if (!carouselTrack || slides.length === 0) return

            let currentIndex = 0
            const totalSlides = slides.length

            // Generate dots dynamically based on slide count
            function generateDots() {
                if (!dotsContainer) return

                dotsContainer.innerHTML = ''
                for (let i = 0; i < totalSlides; i++) {
                    const dot = document.createElement('button')
                    dot.className = `carousel-dot w-3 h-3 rounded-full transition-all duration-200 ${i === 0 ? 'bg-white' : 'bg-white/50'}`
                    dot.setAttribute('data-slide', i.toString())
                    dot.setAttribute('aria-label', `Go to slide ${i + 1}`)
                    dot.addEventListener('click', () => goToSlide(i))
                    dotsContainer.appendChild(dot)
                }
            }

            // Initialize dots
            generateDots()

            // Hide navigation if only one slide
            if (totalSlides <= 1) {
                if (prevButton) prevButton.style.display = 'none'
                if (nextButton) nextButton.style.display = 'none'
                if (dotsContainer) dotsContainer.style.display = 'none'
            }

            // Update carousel position
            function updateCarousel() {
                const translateX = -currentIndex * 100
                ;(carouselTrack as HTMLElement).style.transform = `translateX(${translateX}%)`

                // Update dots
                const currentDots = document.querySelectorAll('.carousel-dot')
                currentDots.forEach((dot, index) => {
                    if (index === currentIndex) {
                        dot.classList.remove('bg-white/50')
                        dot.classList.add('bg-white')
                    } else {
                        dot.classList.remove('bg-white')
                        dot.classList.add('bg-white/50')
                    }
                })
            }

            // Next slide
            function nextSlide() {
                currentIndex = (currentIndex + 1) % totalSlides
                updateCarousel()
            }

            // Previous slide
            function prevSlide() {
                currentIndex = (currentIndex - 1 + totalSlides) % totalSlides
                updateCarousel()
            }

            // Go to specific slide
            function goToSlide(index: number) {
                currentIndex = index
                updateCarousel()
            }

            // Event listeners
            if (nextButton) {
                nextButton.addEventListener('click', nextSlide)
            }

            if (prevButton) {
                prevButton.addEventListener('click', prevSlide)
            }

            // Dots event listeners are now handled in generateDots function

            // Keyboard navigation
            document.addEventListener('keydown', e => {
                if (e.key === 'ArrowLeft') prevSlide()
                if (e.key === 'ArrowRight') nextSlide()
            })

            // Auto-play (optional)
            let autoPlayInterval = setInterval(nextSlide, 5000)

            // Pause auto-play on hover
            const carouselContainer = document.querySelector('.relative.max-w-\\[800px\\]')
            if (carouselContainer) {
                carouselContainer.addEventListener('mouseenter', () => {
                    clearInterval(autoPlayInterval)
                })

                carouselContainer.addEventListener('mouseleave', () => {
                    autoPlayInterval = setInterval(nextSlide, 5000)
                })
            }
        })
    </script>

    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</Layout>
