---
import type { PageMeta } from '@stephenchenorg/astro/page'
import type { TeamMember } from '@/types'
import { seoMeta } from '@stephenchenorg/astro/page'
import { getLocale } from 'i18n:astro'
import { getAllTeams, getTeamMemberBySlug } from '@/api/teams'
import Schedule from '@/components/ui/Schedule.astro'
import Layout from '@/layouts/Layout.astro'
import SectionTitle from '@/components/ui/SectionTitle.astro'
import TeamCard from '@/components/ui/TeamCard.astro'
import { createNestedT, getLinkByLocale } from '@/utils/i18n'
import { getCanonicalUrl, getSeoConfig } from '@/utils/seoConfig'

const t = createNestedT()
const currentLocale = getLocale()
const isEnglish = currentLocale === 'en'
const locale = currentLocale === 'en' ? 'en' : 'zh_TW'

// 取得路由參數
const { slug } = Astro.params

if (!slug) {
  return Astro.rewrite('/404')
}

// 定義分類對應的 type ID 和 slug
const categoryMap: Record<string, { typeId: number; titleKey: string }> = {
  'today': { typeId: 20, titleKey: 'team.types.available' },
  'new': { typeId: 30, titleKey: 'team.types.new' },
  'recommend': { typeId: 40, titleKey: 'team.types.recommended' },
}

// 檢查是否為有效的分類路由
const categoryConfig = categoryMap[slug]

// 定義類型別名
type PageType = 'category' | 'member'
let pageType: PageType = 'category'
let teamMember: TeamMember | null = null
let teamMembers: TeamMember[] = []
let teamsData: any = null

const types = [
  { id: 10, slug: '', title: t('team.types.all') },
  { id: 20, slug: 'today', title: t('team.types.available') },
  { id: 30, slug: 'new', title: t('team.types.new') },
  { id: 40, slug: 'recommend', title: t('team.types.recommended') },
]

if (categoryConfig) {
  // 這是分類頁面
  pageType = 'category'
  const url = new URL(Astro.request.url)
  const currentPage = Number.parseInt(url.searchParams.get('page') || '1', 10)

  try {
    teamsData = await getAllTeams(categoryConfig.typeId, currentPage, 12)
    teamMembers = teamsData.teams.data || []
  } catch (error) {
    console.error('Failed to fetch team members:', error)
  }
} else {
  // 嘗試作為團隊成員 slug 處理
  try {
    teamMember = await getTeamMemberBySlug(slug)

    if (!teamMember) {
      return Astro.rewrite('/404')
    }
    pageType = 'member'
  } catch (error) {
    console.error('Failed to fetch team member:', error)
    return Astro.rewrite('/404')
  }
}

// 建立 SEO 設定
const defaultSeo = getSeoConfig('team', locale)
let meta: PageMeta

if (pageType === 'member' && teamMember) {
  const validImages = teamMember.images?.filter(img => img.image?.desktop || img.image?.mobile) || []
  const mainImageDesktop = validImages[0]?.image?.desktop || validImages[0]?.image?.mobile

  meta = {
    ...seoMeta({
      title: teamMember.seo_title || defaultSeo.seo_title,
      seo_description: teamMember.seo_description || defaultSeo.seo_description,
      seo_keyword: teamMember.seo_keyword || defaultSeo.seo_keyword,
      og_title: teamMember.og_title || defaultSeo.og_title,
      og_description: teamMember.og_description || defaultSeo.og_description,
      og_image: teamMember.og_image || mainImageDesktop || defaultSeo.og_image,
      seo_head: teamMember.seo_head,
      seo_body: teamMember.seo_body,
      seo_json_ld: teamMember.seo_json_ld,
    }),
    canonical: getCanonicalUrl(`team/${slug}`, locale),
  } as PageMeta
} else {
  meta = {
    ...seoMeta(defaultSeo),
    canonical: getCanonicalUrl(`team/${slug}`, locale),
  } as PageMeta
}

// 為團隊成員詳細頁準備圖片資料
const validImages = teamMember?.images?.filter(img => img.image?.desktop || img.image?.mobile) || []
const mainImageDesktop = validImages[0]?.image?.desktop || validImages[0]?.image?.mobile
const mainImageMobile = validImages[0]?.image?.mobile || validImages[0]?.image?.desktop

const url = new URL(Astro.request.url)
const currentPage = Number.parseInt(url.searchParams.get('page') || '1', 10)
---

<Layout meta={meta}>
  {pageType === 'category' && categoryConfig ? (
    <main class="relative z-10 w-full min-h-screen px-4 md:px-6 lg:px-8 bg-theme-bg text-theme-text" style="padding-top: 120px; padding-bottom: 40px;">
      <SectionTitle title={t('team.title')} subtitle={t('team.subtitle')} />

      <div class="max-w-6xl mx-auto w-full">
        {types.length > 1 && (
          <div class="w-full mb-8 px-4">
            <div class="max-w-4xl mx-auto">
              <div style="border-radius: 12px; padding: 8px;">
                <div class="flex flex-wrap gap-2 justify-center">
                  {types.map(type => (
                    <a
                      href={type.slug ? getLinkByLocale(`/team/${type.slug}`) : getLinkByLocale('/team')}
                      class={`tab-item px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap text-center no-underline border-0 cursor-pointer ${categoryConfig.typeId === type.id ? 'active' : ''}`}
                      style={categoryConfig.typeId === type.id ? 'background-color: var(--color-primary-500); color: white;' : 'background-color: var(--color-neutral-100); color: var(--theme-text);'}
                    >
                      {type.title}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {teamMembers && teamMembers.length > 0 ? (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {teamMembers.map(member => (
              <TeamCard member={member} uniqueId={`team-${member.id}`} />
            ))}
          </div>
        ) : (
          <div class="flex flex-col items-center justify-center py-16 px-4">
            <svg class="w-20 h-20 text-neutral-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <p class="text-neutral-500 text-lg">{t('team.noTeamMembers')}</p>
          </div>
        )}

        {teamMembers && teamMembers.length > 0 && teamsData && teamsData.teams.last_page > 1 && (
          <div class="flex justify-center items-center space-x-2 mt-8">
            {Array.from({ length: teamsData.teams.last_page }, (_, i) => {
              const pageNum = i + 1
              return (
                <a
                  href={getLinkByLocale(`/team/${slug}?page=${pageNum}`)}
                  class={`px-3 py-2 rounded-lg border transition-all duration-300 ${isEnglish ? 'text-sm' : 'text-base'}`}
                  style={pageNum === currentPage
                    ? 'background-color: var(--color-primary-500); border-color: var(--color-primary-500); color: white;'
                    : 'border-color: var(--theme-border); background-color: var(--theme-card-bg); color: var(--theme-text);'}
                >
                  {pageNum}
                </a>
              )
            })}
          </div>
        )}
      </div>
    </main>
  ) : teamMember ? (
    <>
    <main class="section-container">
      <div class="flex flex-col lg:flex-row items-start gap-6 lg:gap-8 max-w-6xl mx-auto px-4 sm:px-6">
        <div class="block lg:hidden w-full">
          <h1 class="font-bold text-3xl md:text-4xl leading-tight text-[var(--theme-text,#1f2937)]">
            {teamMember.title}
            {teamMember.job && (
              <span class="text-lg font-normal text-[var(--theme-text-secondary,#6b7280)]">  {teamMember.job}</span>
            )}
          </h1>
        </div>

        <div class="flex flex-col items-center w-full lg:w-5/12">
          <div class="relative w-full aspect-square max-w-lg mx-auto overflow-hidden border-2 shadow-lg bg-[var(--theme-card-bg,#ffffff)] border-[var(--theme-border,#e5e7eb)]">
            {validImages.length > 1 && (
              <>
                <button
                  type="button"
                  class="absolute left-3 top-1/2 -translate-y-1/2 z-10 bg-[var(--theme-card-bg,#ffffff)]/90 hover:bg-[var(--theme-card-bg,#ffffff)] rounded-full p-2 shadow-md transition-all duration-200 text-[var(--theme-text,#1f2937)]"
                  onclick="carouselPrev()"
                  aria-label="上一張"
                >
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M15 18l-6-6 6-6" />
                  </svg>
                </button>
                <button
                  type="button"
                  class="absolute right-3 top-1/2 -translate-y-1/2 z-10 bg-[var(--theme-card-bg,#ffffff)]/90 hover:bg-[var(--theme-card-bg,#ffffff)] rounded-full p-2 shadow-md transition-all duration-200 text-[var(--theme-text,#1f2937)]"
                  onclick="carouselNext()"
                  aria-label="下一張"
                >
                  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9 18l6-6-6-6" />
                  </svg>
                </button>
              </>
            )}

            <img
              id="carousel-img-mobile"
              src={mainImageMobile}
              alt={teamMember.title}
              class="w-full h-full object-cover object-center select-none transition-all duration-300 md:hidden"
              loading="eager"
              fetchpriority="high"
            />
            <img
              id="carousel-img-desktop"
              src={mainImageDesktop}
              alt={teamMember.title}
              class="w-full h-full object-cover object-center select-none transition-all duration-300 hidden md:block"
              loading="eager"
              fetchpriority="high"
            />
          </div>

          {validImages.length > 1 && (
            <div id="carousel-thumbs" class="flex flex-wrap justify-center gap-3 mt-6 max-w-lg">
              {validImages.map((img, idx) => (
                <picture>
                  <source media="(min-width: 768px)" srcset={img.image?.desktop || img.image?.mobile} />
                  <img
                    src={img.image?.mobile || img.image?.desktop}
                    alt={`${t('team.thumbnail')}${idx + 1}`}
                    class={`w-20 h-20 object-contain rounded-lg border-2 cursor-pointer transition-all duration-200 shadow-sm ${
                      idx === 0
                        ? 'border-[var(--color-primary-500,#3b82f6)] ring-2 ring-[var(--color-primary-200,#bfdbfe)]'
                        : 'border-[var(--theme-border,#e5e7eb)] hover:border-[var(--theme-text-secondary,#6b7280)] hover:shadow-md'
                    }`}
                    onclick={`carouselThumb(${idx})`}
                    loading="lazy"
                  />
                </picture>
              ))}
            </div>
          )}
        </div>

        <div class="flex-1 flex flex-col items-start lg:w-7/12">
          <h1 class="hidden lg:block font-bold text-3xl md:text-4xl mb-6 leading-tight text-[var(--theme-text,#1f2937)]">
            {teamMember.title}
            {teamMember.job && (
              <span class="text-lg font-normal text-[var(--theme-text-secondary,#6b7280)]">  {teamMember.job}</span>
            )}
          </h1>

          <div class="w-full rounded-xl p-6 shadow-sm border-2 bg-[var(--theme-card-bg,#ffffff)] border-[var(--theme-border,#e5e7eb)] text-[var(--theme-text,#1f2937)] space-y-6">
            <div>
              <h4 class="text-lg font-semibold mb-4 text-[var(--theme-text,#1f2937)] flex items-center gap-2">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {t('team.schedule')}
              </h4>
              <Schedule teamMember={teamMember} />
            </div>

            {(teamMember.height || teamMember.weight || teamMember.years || teamMember.age) && (
              <>
                <div class="border-t border-[var(--theme-border,#e5e7eb)]"></div>
                <div>
                  <h4 class="text-lg font-semibold mb-4 text-[var(--theme-text,#1f2937)] flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                      <circle cx="12" cy="7" r="4" />
                    </svg>
                    {t('team.personalInfo')}
                  </h4>
                  <div class="space-y-3">
                    {teamMember.height && (
                      <div class="flex justify-between items-center py-2">
                        <span class="text-[var(--theme-text-secondary,#6b7280)]">{t('team.height')}</span>
                        <span class="font-semibold text-[var(--theme-text,#1f2937)]">{teamMember.height} cm</span>
                      </div>
                    )}
                    {teamMember.weight && (
                      <div class="flex justify-between items-center py-2">
                        <span class="text-[var(--theme-text-secondary,#6b7280)]">{t('team.weight')}</span>
                        <span class="font-semibold text-[var(--theme-text,#1f2937)]">{teamMember.weight} kg</span>
                      </div>
                    )}
                    {teamMember.years && (
                      <div class="flex justify-between items-center py-2">
                        <span class="text-[var(--theme-text-secondary,#6b7280)]">{t('team.experience')}</span>
                        <span class="font-semibold text-[var(--theme-text,#1f2937)]">{teamMember.years} {t('team.years')}</span>
                      </div>
                    )}
                    {teamMember.age && (
                      <div class="flex justify-between items-center py-2">
                        <span class="text-[var(--theme-text-secondary,#6b7280)]">{t('team.age')}</span>
                        <span class="font-semibold text-[var(--theme-text,#1f2937)]">{teamMember.age} {t('team.yearsOld')}</span>
                      </div>
                    )}
                  </div>
                </div>
              </>
            )}

            <div class="border-t border-[var(--theme-border,#e5e7eb)]"></div>

            <div>
              <h4 class="text-lg font-semibold mb-4 text-[var(--theme-text,#1f2937)] flex items-center gap-2">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                {t('team.introduction')}
              </h4>
              <div class="prose prose-lg max-w-none leading-relaxed">
                {teamMember.content ? (
                  <div set:html={teamMember.content} />
                ) : (
                  <p class="text-[var(--theme-text-secondary,#6b7280)]">{t('team.noIntroduction')}</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    {validImages.length > 0 && (
      <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
        <div class="relative max-w-4xl max-h-full">
          <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
          <img id="lightbox-img" src="" alt="" class="max-w-full max-h-full object-contain" />
          <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2" id="lightbox-dots">
            {validImages.map((_, idx) => (
              <button
                class="w-3 h-3 rounded-full bg-white/50 hover:bg-white/80 transition-all duration-200"
                data-idx={idx}
                onclick={`showLightboxImage(${idx})`}
              />
            ))}
          </div>
        </div>
      </div>
    )}

    {validImages.length > 0 && (
      <script
        type="module"
        is:inline
        define:vars={{
          teamImagesDesktop: validImages.map(img => img.image?.desktop || img.image?.mobile).filter(Boolean),
          teamImagesMobile: validImages.map(img => img.image?.mobile || img.image?.desktop).filter(Boolean),
          allImages: validImages,
        }}
      >
        document.addEventListener('DOMContentLoaded', () => {
          let currentIndex = 0
          let lightboxIndex = 0
          const imgElementMobile = document.getElementById('carousel-img-mobile')
          const imgElementDesktop = document.getElementById('carousel-img-desktop')
          const dotElements = document.querySelectorAll('#carousel-dots button')
          const thumbElements = document.querySelectorAll('#carousel-thumbs img')
          const lightbox = document.getElementById('lightbox')
          const lightboxImg = document.getElementById('lightbox-img')
          const lightboxDots = document.querySelectorAll('#lightbox-dots button')

          function updateCarousel() {
            if (imgElementMobile && teamImagesMobile[currentIndex]) {
              imgElementMobile.src = teamImagesMobile[currentIndex]
              imgElementMobile.alt = `作品圖${currentIndex + 1}`
            }
            if (imgElementDesktop && teamImagesDesktop[currentIndex]) {
              imgElementDesktop.src = teamImagesDesktop[currentIndex]
              imgElementDesktop.alt = `作品圖${currentIndex + 1}`
            }

            dotElements.forEach((dot, index) => {
              if (index === currentIndex) {
                dot.className = 'w-2.5 h-2.5 rounded-full transition-all duration-200 bg-[var(--color-primary-500,#3b82f6)] shadow-lg'
              } else {
                dot.className = 'w-2.5 h-2.5 rounded-full transition-all duration-200 bg-[var(--theme-card-bg,#ffffff)]/60 hover:bg-[var(--theme-card-bg,#ffffff)]/80'
              }
            })

            thumbElements.forEach((thumb, index) => {
              if (index === currentIndex) {
                thumb.className = 'w-20 h-20 object-contain rounded-lg border-2 cursor-pointer transition-all duration-200 shadow-sm border-[var(--color-primary-500,#3b82f6)] ring-2 ring-[var(--color-primary-200,#bfdbfe)]'
              } else {
                thumb.className = 'w-20 h-20 object-contain rounded-lg border-2 cursor-pointer transition-all duration-200 shadow-sm border-[var(--theme-border,#e5e7eb)] hover:border-[var(--theme-text-secondary,#6b7280)] hover:shadow-md'
              }
            })
          }

          function updateLightbox() {
            if (lightboxImg && allImages[lightboxIndex]) {
              lightboxImg.src = allImages[lightboxIndex].image?.desktop || allImages[lightboxIndex].image?.mobile
              lightboxImg.alt = `作品 ${lightboxIndex + 1}`
            }

            lightboxDots.forEach((dot, index) => {
              if (index === lightboxIndex) {
                dot.className = 'w-3 h-3 rounded-full bg-white transition-all duration-200'
              } else {
                dot.className = 'w-3 h-3 rounded-full bg-white/50 hover:bg-white/80 transition-all duration-200'
              }
            })
          }

          window.carouselPrev = () => {
            currentIndex = (currentIndex - 1 + teamImagesDesktop.length) % teamImagesDesktop.length
            updateCarousel()
          }

          window.carouselNext = () => {
            currentIndex = (currentIndex + 1) % teamImagesDesktop.length
            updateCarousel()
          }

          window.carouselThumb = index => {
            currentIndex = index
            updateCarousel()
          }

          window.openLightbox = index => {
            lightboxIndex = index
            lightbox.classList.remove('hidden')
            lightbox.classList.add('flex')
            updateLightbox()
            document.body.style.overflow = 'hidden'
          }

          window.closeLightbox = () => {
            lightbox.classList.add('hidden')
            lightbox.classList.remove('flex')
            document.body.style.overflow = 'auto'
          }

          window.showLightboxImage = index => {
            lightboxIndex = index
            updateLightbox()
          }

          document.addEventListener('keydown', e => {
            if (lightbox.classList.contains('flex')) {
              if (e.key === 'Escape') {
                window.closeLightbox()
              } else if (e.key === 'ArrowLeft') {
                lightboxIndex = (lightboxIndex - 1 + allImages.length) % allImages.length
                updateLightbox()
              } else if (e.key === 'ArrowRight') {
                lightboxIndex = (lightboxIndex + 1) % allImages.length
                updateLightbox()
              }
            }
          })

          lightbox?.addEventListener('click', e => {
            if (e.target === lightbox) {
              window.closeLightbox()
            }
          })

          if (teamImagesDesktop.length > 1) {
            updateCarousel()
            setInterval(() => {
              currentIndex = (currentIndex + 1) % teamImagesDesktop.length
              updateCarousel()
            }, 5000)
          }
        })
      </script>
    )}
    </>
  ) : (
    <div>404</div>
  )}
</Layout>
