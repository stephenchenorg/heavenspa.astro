---
import {type PageMeta, seoMeta} from '@stephenchenorg/astro/page'
import { getLocale } from 'i18n:astro'
import { getServiceCategories } from '@/api/serviceCategories'
import { getServices } from '@/api/services'
import Button from '@/components/ui/Button.astro'
import Layout from '@/layouts/Layout.astro'
import { createNestedT } from '@/utils/i18n'
import {createDynamicSeo, getCanonicalUrl, getSeoConfig} from '@/utils/seoConfig'

const t = await createNestedT()
const currentLocale = getLocale()
const isEnglish = currentLocale === 'en'
const locale = currentLocale === 'en' ? 'en' : 'zh_TW'

// 取得路由參數
const { category_id } = Astro.params
const url = new URL(Astro.request.url)
const currentPage = Number.parseInt(url.searchParams.get('page') || '1', 10)

// 先取得分類資料
const categoriesData = await getServiceCategories()

const categories = categoriesData.serviceCategories.data

// 使用路由參數中的 category_id
const categoryId = category_id ? Number.parseInt(category_id, 10) : (categories.length > 0 ? Number.parseInt(categories[0].id, 10) : 1)

// 找到當前分類
const currentCategory = categories.find(cat => Number.parseInt(cat.id, 10) === categoryId) || categories[0]

// 取得服務資料
const servicesData = await getServices(categoryId, currentPage, 10, '')
const services = servicesData.services.data

const categoryTitle = currentCategory?.title || '服務項目'
const coverImage = currentCategory?.cover?.desktop || currentCategory?.cover?.mobile

// 建立 SEO 設定 - 使用 API 資料，沒有則使用預設值
const defaultSeo = getSeoConfig('services', locale)

const meta = seoMeta({
  title: currentCategory?.title || defaultSeo.title,
  seo_title: currentCategory?.seo_title || defaultSeo.seo_title,
  seo_description: currentCategory?.seo_description || defaultSeo.seo_description,
  seo_keyword: currentCategory?.seo_keyword || defaultSeo.seo_keyword,
  og_title: currentCategory?.og_title || defaultSeo.og_title,
  og_description: currentCategory?.og_description || defaultSeo.og_description,
  og_image: currentCategory?.og_image || coverImage || defaultSeo.og_image,
  canonical: getCanonicalUrl(`services/${category_id}/items`, locale),
  // 後台額外欄位 (有值才顯示)
  seo_head: currentCategory?.seo_head,
  seo_body: currentCategory?.seo_body,
  seo_json_ld: currentCategory?.seo_json_ld,
} as PageMeta)

---

<Layout meta={meta}>
  <main class="section-container">

    <!-- 分類橫幅 -->
    {currentCategory && (
      <section class="relative w-full h-64 md:h-80 lg:h-96 mb-8 overflow-hidden">
        <!-- 背景圖片 -->
        <!-- Mobile Background -->
        <div
          class="absolute inset-0 bg-cover bg-center md:hidden"
          style={`background-image: url('${currentCategory.background?.mobile || currentCategory.background?.desktop}')`}
        >
        </div>
        <!-- Desktop Background -->
        <div
          class="absolute inset-0 bg-cover bg-center hidden md:block"
          style={`background-image: url('${currentCategory.background?.desktop || currentCategory.background?.mobile}')`}
        >
        </div>
        <!-- 漸層遮罩 -->
        <div class="absolute inset-0 bg-black/40"></div>
        <!-- 文字內容 -->
        <div class="relative z-10 flex items-center justify-center h-full text-center text-white px-4">
          <div class={`${isEnglish ? 'max-w-6xl' : 'max-w-4xl'}`}>
            <h1 class={`font-bold mb-4 ${isEnglish ? 'text-[clamp(1.75rem,5vw,3rem)]' : 'text-4xl md:text-5xl lg:text-6xl'}`}>{currentCategory.title}</h1>
            {currentCategory.sub_title && (
              <p class={`text-white/80 mb-3 ${isEnglish ? 'text-base md:text-lg' : 'text-lg md:text-xl'}`}>{currentCategory.sub_title}</p>
            )}
            {currentCategory.description && (
              <p class={`text-white/70 mx-auto leading-relaxed ${isEnglish ? 'text-sm max-w-4xl' : 'text-sm md:text-base max-w-2xl'}`}>{currentCategory.description}</p>
            )}
          </div>
        </div>
      </section>
    )}

    <div class="max-w-6xl mx-auto w-full">
      <div class="mb-8 px-4">
        <div class="max-w-4xl mx-auto">
          <div class="flex flex-wrap gap-2 justify-center">
            {categories.map(category => (
              <a
                href={`/services/${category.id}/items`}
                class={`px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap text-center no-underline border-0 cursor-pointer ${
                  categoryId === Number.parseInt(category.id, 10)
                    ? 'active'
                    : ''
                }`}
                style={categoryId === Number.parseInt(category.id, 10) ? 'background-color: var(--color-primary-500); color: white;' : 'background-color: var(--color-neutral-100); color: var(--theme-text);'}
                role="tab"
                aria-selected={categoryId === Number.parseInt(category.id, 10)}
              >
                {category.title}
              </a>
            ))}
          </div>
        </div>
      </div>
      <!-- 服務網格 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-8 w-full">
        {services.map(service => (
          <div class="group cursor-pointer transform transition-transform duration-700
                hover:scale-95 active:scale-90 relative backdrop-blur-sm overflow-hidden w-full flex flex-col"
          >
            <a href={`/services/${categoryId}/items/${service.id}`} class="flex flex-col">
              <!-- 上半部：封面圖 -->
              <div class="relative w-full overflow-hidden aspect-square">
                <!-- Background Image - Mobile -->
                <div
                  class="absolute inset-0 bg-cover bg-center md:hidden"
                  style={`background-image: url('${service.cover?.mobile || service.cover?.desktop || 'https://imagefaker.access.mx.com/1920x1080/282828/eae0d0/?retina=1'}')`}
                >
                </div>
                <!-- Background Image - Desktop -->
                <div
                  class="absolute inset-0 bg-cover bg-center hidden md:block"
                  style={`background-image: url('${service.cover?.desktop || service.cover?.mobile || 'https://imagefaker.access.mx.com/1920x1080/282828/eae0d0/?retina=1'}')`}
                >
                </div>
                <!-- Base Overlay for better text readability -->
                <div class="absolute inset-0 bg-black/20"></div>
                <!-- Hover Overlay -->
                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                <!-- VIEW MORE Button Overlay -->
                <Button
                  variant="ghost"
                  text={t('buttons.view-more')}
                  size="small"
                  icon="→"
                  wrapperClass="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                />

                <!-- 時間與價格資訊（圖片底部） -->
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3">
                  <div class="flex items-center gap-3 text-sm text-white">
                    {service.time_min && service.time_max && (
                      <span class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {service.time_min === service.time_max
                          ? `${service.time_min}${isEnglish ? ' min' : ' 分鐘'}`
                          : `${service.time_min}-${service.time_max}${isEnglish ? ' min' : ' 分鐘'}`}
                      </span>
                    )}
                    {service.price_min && service.price_max && (
                      <span class="flex items-center gap-1 text-primary-400 font-semibold">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {service.price_min === service.price_max
                          ? `$${service.price_min.toLocaleString()}`
                          : `$${service.price_min.toLocaleString()}-$${service.price_max.toLocaleString()}`}
                      </span>
                    )}
                  </div>
                </div>
              </div>
              <!-- 標題區域 -->
              <div class="p-4 flex-1 flex items-center">
                <p class={`text-neutral-900 font-medium line-clamp-2 ${isEnglish ? 'text-base' : 'text-lg'}`}>{service.title}</p>
              </div>
            </a>
          </div>
        ))}
      </div>

      <!-- 分頁器 -->
      <div class="flex justify-center items-center space-x-2">
        {Array.from({ length: servicesData.services.last_page }, (_, i) => {
          const pageNum = i + 1
          return (
            <a
              href={`/services/${categoryId}/items?page=${pageNum}`}
              class={`px-3 py-2 rounded-lg border transition-all duration-300 ${isEnglish ? 'text-sm' : 'text-base'}`}
              style={pageNum === currentPage
                      ? 'background-color: var(--color-primary-500); border-color: var(--color-primary-500); color: white;'
                      : 'border-color: var(--theme-border); background-color: var(--theme-card-bg); color: var(--theme-text);'}
            >
              {pageNum}
            </a>
          )
        })}
      </div>
    </div>

  </main>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* English language optimizations for banner */
    .banner-en-title {
      word-break: break-word;
      hyphens: auto;
      letter-spacing: -0.01em;
    }

    .banner-en-subtitle {
      word-break: break-word;
      hyphens: auto;
      letter-spacing: 0.025em;
    }

    .banner-en-description {
      word-break: break-word;
      hyphens: auto;
      line-height: 1.6;
    }

    /* Service cards English optimizations */
    .service-en-title {
      word-break: break-word;
      hyphens: auto;
      letter-spacing: 0.025em;
    }

    /* Responsive adjustments for English content */
    @media (max-width: 768px) {
      .banner-en-title {
        line-height: 1.1;
      }

      .banner-en-subtitle {
        font-size: 0.875rem;
      }

      .banner-en-description {
        font-size: 0.75rem;
        line-height: 1.5;
      }

      .service-en-title {
        font-size: 0.875rem;
        line-height: 1.25;
      }
    }
  </style>
</Layout>
