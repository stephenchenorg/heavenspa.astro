---
import { seoMeta } from '@stephenchenorg/astro/page'
import { getServiceCategories } from '@/api/serviceCategories'
import { getServices } from '@/api/services'
import Button from '@/components/ui/Button.astro'
import Layout from '@/layouts/Layout.astro'
import { createNestedT } from '@/utils/i18n'
import { getLocale } from 'i18n:astro'

const t = await createNestedT()
const currentLocale = getLocale()
const isEnglish = currentLocale === 'en'

// 取得路由參數
const { category_id } = Astro.params
const url = new URL(Astro.request.url)
const currentPage = Number.parseInt(url.searchParams.get('page') || '1', 10)

// 先取得分類資料
const categoriesData = await getServiceCategories()

const categories = categoriesData.serviceCategories.data

// 使用路由參數中的 category_id
const categoryId = category_id ? Number.parseInt(category_id, 10) : (categories.length > 0 ? Number.parseInt(categories[0].id, 10) : 1)

// 找到當前分類
const currentCategory = categories.find(cat => Number.parseInt(cat.id, 10) === categoryId) || categories[0]

// 取得服務資料
const servicesData = await getServices(categoryId, currentPage, 10, '')
const services = servicesData.services.data

const meta = seoMeta({
  title: `${currentCategory?.title || '服務項目'} - Heaven Spa`,
  description: `探索 Heaven Spa 的 ${currentCategory?.title || ''} 服務項目，享受頂級的美容護理體驗。`,
})

---

<Layout meta={meta}>
  <main class="section-container">

    <!-- 分類橫幅 -->
    {currentCategory && (
      <section class="relative w-full h-64 md:h-80 lg:h-96 mb-8 overflow-hidden">
        <!-- 背景圖片 -->
        <div
          class="absolute inset-0 bg-cover bg-center"
          style={`background-image: url('${currentCategory.background?.desktop}')`}
        >
        </div>
        <!-- 漸層遮罩 -->
        <div class="absolute inset-0 bg-black/40"></div>
        <!-- 文字內容 -->
        <div class="relative z-10 flex items-center justify-center h-full text-center text-white px-4">
          <div class={`${isEnglish ? 'max-w-6xl' : 'max-w-4xl'}`}>
            <h1 class={`font-bold mb-4 ${isEnglish ? 'text-[clamp(1.75rem,5vw,3rem)]' : 'text-4xl md:text-5xl lg:text-6xl'}`}>{currentCategory.title}</h1>
            {currentCategory.sub_title && (
              <p class={`text-white/80 mb-3 ${isEnglish ? 'text-base md:text-lg' : 'text-lg md:text-xl'}`}>{currentCategory.sub_title}</p>
            )}
            {currentCategory.description && (
              <p class={`text-white/70 mx-auto leading-relaxed ${isEnglish ? 'text-sm max-w-4xl' : 'text-sm md:text-base max-w-2xl'}`}>{currentCategory.description}</p>
            )}
          </div>
        </div>
      </section>
    )}

    <div class="max-w-6xl mx-auto w-full">
      <div class="mb-8">
        <ul class="flex justify-center flex-wrap text-sm font-medium text-center" id="default-tab" role="tablist">
          {categories.map(category => (
            <li class="me-2" role="presentation">
              <a
                href={`/services/${category.id}/items`}
                class={`inline-block p-4 border-b-2 rounded-t-lg transition-all duration-300 ${
                  categoryId === Number.parseInt(category.id, 10)
                    ? 'border-neutral-900'
                    : 'border-transparent hover:border-neutral-900'
                }`}
                role="tab"
                aria-selected={categoryId === Number.parseInt(category.id, 10)}
              >
                {category.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
      <!-- 服務網格 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-8 w-full">
        {services.map(service => (
          <div class="group cursor-pointer transform transition-transform duration-700
                hover:scale-95 active:scale-90 relative backdrop-blur-sm overflow-hidden w-full flex flex-col"
          >
            <a href={`/services/${categoryId}/items/${service.id}`} class="flex flex-col">
              <!-- 上半部：封面圖 -->
              <div class="relative w-full overflow-hidden aspect-square">
                <!-- Background Image -->
                <div
                  class="absolute inset-0 bg-cover bg-center"
                  style={`background-image: url('${service.cover?.desktop || 'https://imagefaker.access.mx.com/1920x1080/282828/eae0d0/?retina=1'}')`}
                >
                </div>
                <!-- Base Overlay for better text readability -->
                <div class="absolute inset-0 bg-black/20"></div>
                <!-- Hover Overlay -->
                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                <!-- VIEW MORE Button Overlay -->
                <Button
                  variant="ghost"
                  text={t('buttons.view-more')}
                  size="small"
                  icon="→"
                  wrapperClass="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                />
              </div>
              <!-- 標題區域 -->
              <div class="p-4 flex-1 flex items-center">
                <p class={`text-neutral-900 font-medium line-clamp-2 ${isEnglish ? 'text-base' : 'text-lg'}`}>{service.title}</p>
              </div>
            </a>
          </div>
        ))}
      </div>

      <!-- 分頁器 -->
      <div class="flex justify-center items-center space-x-2">
        {Array.from({ length: servicesData.services.last_page }, (_, i) => {
          const pageNum = i + 1
          return (
            <a
              href={`/services/${categoryId}/items?page=${pageNum}`}
              class={`px-3 py-2 rounded-lg border transition-all duration-300 ${isEnglish ? 'text-sm' : 'text-base'}`}
              style={pageNum === currentPage
                      ? 'background-color: var(--color-primary-500); border-color: var(--color-primary-500); color: white;'
                      : 'border-color: var(--theme-border); background-color: var(--theme-card-bg); color: var(--theme-text);'}
            >
              {pageNum}
            </a>
          )
        })}
      </div>
    </div>

  </main>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* English language optimizations for banner */
    .banner-en-title {
      word-break: break-word;
      hyphens: auto;
      letter-spacing: -0.01em;
    }

    .banner-en-subtitle {
      word-break: break-word;
      hyphens: auto;
      letter-spacing: 0.025em;
    }

    .banner-en-description {
      word-break: break-word;
      hyphens: auto;
      line-height: 1.6;
    }

    /* Service cards English optimizations */
    .service-en-title {
      word-break: break-word;
      hyphens: auto;
      letter-spacing: 0.025em;
    }

    /* Responsive adjustments for English content */
    @media (max-width: 768px) {
      .banner-en-title {
        line-height: 1.1;
      }

      .banner-en-subtitle {
        font-size: 0.875rem;
      }

      .banner-en-description {
        font-size: 0.75rem;
        line-height: 1.5;
      }

      .service-en-title {
        font-size: 0.875rem;
        line-height: 1.25;
      }
    }
  </style>
</Layout>
