---
import { seoMeta } from '@stephenchenorg/astro/page'
import { graphQLAPI, gql } from '@/api'
import Button from '@/components/ui/Button.astro'
import SectionTitle from '@/components/ui/SectionTitle.astro'
import Layout from '@/layouts/Layout.astro'
import { createNestedT } from '@/utils/i18n'

const t = await createNestedT()

// 取得 URL 參數
const url = new URL(Astro.request.url)
const currentPage = parseInt(url.searchParams.get('page') || '1', 10)
const currentCategoryId = url.searchParams.get('category_id')

const GET_SERVICE_CATEGORIES = gql`
  query GetServiceCategories {
    serviceCategories {
      data {
        id
        title
        sub_title
        description
        cover {
          desktop
          desktop_blur
          mobile
          mobile_blur
        }
        background {
          desktop
          desktop_blur
          mobile
          mobile_blur
        }
      }
    }
  }
`

const GET_SERVICES = gql`
  query GetServices($page: Int!, $per_page: Int!, $search: String, $category_id: Int) {
    services(page: $page, per_page: $per_page, search: $search, category_id: $category_id) {
      data {
        content_1
        content_2
        content_3
        content_4
        cover
        title
        id
        service_category_id
      }
      from
      has_more_pages
      last_page
      per_page
      to
      total
    }
  }
`

// 先取得分類資料
const categoriesData = await graphQLAPI<{
  serviceCategories: {
    data: Array<{
      id: string
      title: string
      sub_title: string
      description: string
      cover: {
        desktop: string
        desktop_blur: string
        mobile: string
        mobile_blur: string
      }
      background: {
        desktop: string
        desktop_blur: string
        mobile: string
        mobile_blur: string
      }
    }>
  }
}>(GET_SERVICE_CATEGORIES)

const categories = categoriesData.serviceCategories.data

// 如果沒有指定分類，預設使用第一個分類
const categoryId = currentCategoryId ? parseInt(currentCategoryId, 10) : (categories.length > 0 ? parseInt(categories[0].id, 10) : 1)

// 找到當前分類
const currentCategory = categories.find(cat => parseInt(cat.id, 10) === categoryId) || categories[0]

// 取得服務資料
const servicesData = await graphQLAPI<{
  services: {
    data: Array<{
      id: string
      title: string
      content_1: string
      content_2: string
      content_3: string
      content_4: string
      cover: string
      service_category_id: number
    }>
    from: number
    has_more_pages: boolean
    last_page: number
    per_page: number
    to: number
    total: number
  }
}>(GET_SERVICES, {
  variables: {
    page: currentPage,
    per_page: 10,
    search: "",
    category_id: categoryId
  }
})

const services = servicesData.services.data

const meta = seoMeta({
  title: '服務項目 - Heaven Spa',
  description: '探索 Heaven Spa 的專業服務項目，享受頂級的美容護理體驗。',
})

---

<Layout meta={meta}>
  <main class="section-container">

    <!-- 分類橫幅 -->
    {currentCategory && (
      <section class="relative w-full h-64 md:h-80 lg:h-96 mb-8 overflow-hidden">
        <!-- 背景圖片 -->
        <div
          class="absolute inset-0 bg-cover bg-center"
          style={`background-image: url('${currentCategory.cover?.desktop || currentCategory.background?.desktop}')`}
        >
        </div>
        <!-- 漸層遮罩 -->
        <div class="absolute inset-0 bg-black/40"></div>
        <!-- 文字內容 -->
        <div class="relative z-10 flex items-center justify-center h-full text-center text-white px-4">
          <div class="max-w-4xl">
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4">{currentCategory.title}</h1>
            {currentCategory.sub_title && (
              <p class="text-lg md:text-xl text-white/80 mb-3">{currentCategory.sub_title}</p>
            )}
            {currentCategory.description && (
              <p class="text-sm md:text-base text-white/70 max-w-2xl mx-auto leading-relaxed">{currentCategory.description}</p>
            )}
          </div>
        </div>
      </section>
    )}

    <div class="max-w-6xl mx-auto w-full">
      <div class="mb-8">
        <ul class="flex justify-center flex-wrap text-sm font-medium text-center" id="default-tab" role="tablist">
          {categories.map((category) => (
            <li class="me-2" role="presentation">
              <a
                href={`?category_id=${category.id}&page=1`}
                class={`inline-block p-4 border-b-2 rounded-t-lg transition-all duration-300 ${
                  categoryId === parseInt(category.id, 10)
                    ? 'border-neutral-900'
                    : 'border-transparent hover:border-neutral-900'
                }`}
                role="tab"
                aria-selected={categoryId === parseInt(category.id, 10)}
              >
                {category.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
      <!-- 服務網格 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-8 w-full">
        {services.map(service => (
          <div class="group cursor-pointer transform transition-transform duration-700
                hover:scale-95 active:scale-90 relative backdrop-blur-sm overflow-hidden w-full flex flex-col">
            <a href={`/services/${service.id}`} class="flex flex-col">
              <!-- 上半部：封面圖 -->
              <div class="relative w-full overflow-hidden aspect-[5/6]">
                <!-- Background Image
                  style={`background-image: url('${service.cover}')`}
                 -->
                <div
                  class="absolute inset-0 bg-cover bg-center"
                  style={`background-image: url('https://imagefaker.access.mx.com/1920x1080/282828/eae0d0/?retina=1')`}
                >
                </div>
                <!-- Base Overlay for better text readability -->
                <div class="absolute inset-0 bg-black/20"></div>
                <!-- Hover Overlay -->
                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                <!-- VIEW MORE Button Overlay -->
                <Button
                  variant="ghost"
                  text={t('buttons.view-more')}
                  size="small"
                  icon="→"
                  wrapperClass="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                />
              </div>
              <!-- 標題區域 -->
              <div class="p-4 flex-1 flex items-center">
                <p class="text-neutral-900 font-medium text-lg line-clamp-2">{service.title}</p>
              </div>
            </a>
          </div>
        ))}
      </div>

      <!-- 分頁器 -->
      <div class="flex justify-center items-center space-x-2">
        {Array.from({ length: servicesData.services.last_page }, (_, i) => {
          const pageNum = i + 1
          return (
            <a
              href={`?category_id=${categoryId}&page=${pageNum}`}
              class="px-3 py-2 rounded-lg border transition-all duration-300"
              style={pageNum === currentPage
                      ? 'background-color: var(--color-primary-500); border-color: var(--color-primary-500); color: white;'
                      : 'border-color: var(--theme-border); background-color: var(--theme-card-bg); color: var(--theme-text);'}
            >
              {pageNum}
            </a>
          )
        })}
      </div>
    </div>

  </main>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>
