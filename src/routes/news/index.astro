---
import type { PageMeta } from '@stephenchenorg/astro/page'
import { seoMeta } from '@stephenchenorg/astro/page'
import { getLocale } from 'i18n:astro'
import { getArticles } from '@/api/articles'
import Button from '@/components/ui/Button.astro'
import SectionTitle from '@/components/ui/SectionTitle.astro'
import Layout from '@/layouts/Layout.astro'
import { createNestedT, getLinkByLocale } from '@/utils/i18n'
import { getCanonicalUrl, getSeoConfig } from '@/utils/seoConfig'

const t = await createNestedT()
const currentLocale = getLocale()
const isEnglish = currentLocale === 'en'
const locale = currentLocale === 'en' ? 'en' : 'zh_TW'

const url = new URL(Astro.request.url)
const currentPage = Number.parseInt(url.searchParams.get('page') || '1', 10)

const articlesData = await getArticles(currentPage, 12)
const articles = articlesData.articles.data

const seoConfig = getSeoConfig('news', locale)
const meta = {
  ...seoMeta(seoConfig),
  canonical: getCanonicalUrl('news', locale),
} as PageMeta
---

<Layout meta={meta}>
  <main class="section-container">
    <!-- 標題區 -->
    <SectionTitle title={t('news.sectionTitle')} subtitle={t('news.sectionSubtitle')} />

    <div class="max-w-6xl mx-auto w-full">

      <!-- 搜尋器 (裝飾用) -->
      <!--<div class="mb-8 max-w-md mx-auto">-->
      <!--  <div class="relative">-->
      <!--    <input-->
      <!--        type="text"-->
      <!--        placeholder="搜尋新聞..."-->
      <!--        class="w-full px-4 py-3 pl-12 backdrop-blur-sm rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2"-->
      <!--        style="background-color: var(&#45;&#45;theme-card-bg); border: 1px solid var(&#45;&#45;theme-border); color: var(&#45;&#45;theme-text); focus:ring-color: var(&#45;&#45;color-primary-500); focus:border-color: var(&#45;&#45;color-primary-500);"-->
      <!--        disabled-->
      <!--    />-->
      <!--    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 transition-colors duration-300" style="color: var(&#45;&#45;theme-text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">-->
      <!--      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>-->
      <!--    </svg>-->
      <!--  </div>-->
      <!--</div>-->

      <!-- 新聞網格 -->
      {articles && articles.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-8 w-full">
          {articles.map(article => (
            <div
              class="group cursor-pointer transition-all duration-300 hover:-translate-y-2 relative backdrop-blur-sm overflow-hidden border shadow-sm hover:shadow-lg w-full h-full flex flex-col"
              style="background-color: var(--theme-card-bg); border-color: var(--theme-border);"
            >
              <a href={getLinkByLocale(`/news/${article.id}`)} class="h-full flex flex-col">
                <!-- 上半部：封面圖 -->
                <div class="relative w-full aspect-[4/3] overflow-hidden flex-shrink-0">
                  <!-- Background Image - Mobile -->
                  <div
                    class="absolute inset-0 bg-cover bg-center md:hidden"
                    style={`background-image: url('${article.cover?.mobile || article.cover?.desktop || 'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg'}')`}
                  >
                  </div>
                  <!-- Background Image - Desktop -->
                  <div
                    class="absolute inset-0 bg-cover bg-center hidden md:block"
                    style={`background-image: url('${article.cover?.desktop || article.cover?.mobile || 'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg'}')`}
                  >
                  </div>
                  <!-- Base Overlay for better text readability -->
                  <div class="absolute inset-0 bg-black/20"></div>
                  <!-- Hover Overlay -->
                  <div
                    class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                  ></div>

                  <!-- VIEW MORE Button Overlay -->
                  <Button
                    variant="ghost"
                    text={t('buttons.view-more')}
                    size="small"
                    icon="→"
                    wrapperClass="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                  />
                </div>

                <!-- 下半部：標題和資訊 -->
                <div class="p-4 flex-1 flex flex-col justify-between">
                  <!-- Title -->
                  <div class="space-y-2">
                     <h3 class={`font-bold leading-tight tracking-wide transition-colors duration-300 ${isEnglish ? 'text-base' : 'text-lg'}`} style="color: var(--theme-text);">
                        {article.title.length > 30 ? `${article.title.substring(0, 30)}...` : article.title}
                      </h3>
                    <div
                      class="w-12 h-0.5 rounded-full"
                      style="background: linear-gradient(to right, var(--color-primary-500), transparent);"
                    ></div>
                  </div>

                  <!-- Content Summary -->
                  <div
                    class="text-sm leading-relaxed line-clamp-3 h-16 transition-colors duration-300 py-4"
                    style="color: var(--theme-text-secondary);"
                  >
                    {(() => {
                      if (!article.content) return t('news.noContentSummary')
                      // 移除 HTML 標籤

                      const textContent = article.content.replace(/<[^>]*>/g, '')
                      // 截取前50個字

                      return textContent.length > 50 ? `${textContent.substring(0, 50)}...` : textContent
                    })()}
                  </div>
                  <div class="flex items-center justify-between pt-2">
                    {article.author && (
                      <div
                        class="flex items-center space-x-2 text-xs transition-colors duration-300"
                        style="color: var(--theme-text-muted);"
                      >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                          />
                        </svg>
                        <span>{article.author}</span>
                      </div>
                    )}
                    <div
                      class="flex items-center space-x-1 text-sm font-medium transition-colors duration-300"
                      style="color: var(--color-primary-500);"
                    >
                      <span>{t('news.detail')}</span>
                      <svg
                        class="w-4 h-4 transform group-hover:translate-x-1 transition-transform duration-300"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          ))}
        </div>
      ) : (
        <div class="flex flex-col items-center justify-center py-16 px-4">
          <svg class="w-20 h-20 text-neutral-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
          </svg>
          <p class="text-neutral-500 text-lg">
            {t('news.noNewsAvailable')}
          </p>
        </div>
      )}

      <!-- 分頁器 -->
      {articles && articles.length > 0 && (
        <div class="flex justify-center items-center space-x-2">
          {Array.from({ length: articlesData.articles.last_page }, (_, i) => {
            const pageNum = i + 1
            return (
              <a
                href={getLinkByLocale(`/news?page=${pageNum}`)}
                class="px-3 py-2 rounded-lg border transition-all duration-300"
                style={pageNum === currentPage
                  ? 'background-color: var(--color-primary-500); border-color: var(--color-primary-500); color: white;'
                  : 'border-color: var(--theme-border); background-color: var(--theme-card-bg); color: var(--theme-text);'}
              >
                {pageNum}
              </a>
            )
          })}
        </div>
      )}
    </div>

  </main>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>
