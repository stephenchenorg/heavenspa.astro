---
import type { PageMeta } from '@stephenchenorg/astro/page'
import { seoMeta } from '@stephenchenorg/astro/page'
import { getLocale } from 'i18n:astro'
import { getFaqList } from '@/api/faq'
import FAQ from '@/components/FAQ.astro'
import SectionTitle from '@/components/ui/SectionTitle.astro'
import Layout from '@/layouts/Layout.astro'
import { createNestedT } from '@/utils/i18n'
import { getCanonicalUrl, getSeoConfig } from '@/utils/seoConfig'

const t = createNestedT()
const currentLocale = getLocale()
const locale = currentLocale === 'en' ? 'en' : 'zh_TW'

const seoConfig = getSeoConfig('faq', locale)

const meta = {
  ...seoMeta(seoConfig),
  canonical: getCanonicalUrl('faq', locale),
} as PageMeta

// 定義類型
interface FaqItem {
  id: string
  title: string
  content: string
}

interface FaqCategory {
  id: number
  title: string
  key: string
}

// 定義 FAQ 分類資料
const faqCategories: FaqCategory[] = [
  { id: 10, title: t('faq.categories.reservation'), key: 'reservation' },
  { id: 20, title: t('faq.categories.spa'), key: 'massage' },
  { id: 30, title: t('faq.categories.hair_removal'), key: 'wax' },
  { id: 50, title: t('faq.categories.water_shuttle'), key: 'facial' },
]

// 獲取網址參數中的分類 ID
const url = new URL(Astro.request.url)
const categoryId = url.searchParams.get('category_id')
const selectedCategoryId = categoryId ? Number.parseInt(categoryId) : 10

let faqs: FaqItem[] = []
let selectedCategory: FaqCategory | null = null

try {
  selectedCategory = faqCategories.find(cat => cat.id === selectedCategoryId) || null
  faqs = await getFaqList(selectedCategoryId)
} catch (error) {
  console.error('Error fetching FAQ data:', error)
}

---

<Layout meta={meta}>
  <main class="section-container">
    <!-- 標題區 -->
    <SectionTitle title={t('faq.sectionTitle')} subtitle={t('faq.sectionSubtitle')} />
    <div class="max-w-6xl mx-auto w-full">

    <!-- Tab Navigation -->
    {faqCategories.length > 1 && (
      <div class="w-full mb-8 px-4">
        <div class="max-w-4xl mx-auto">
          <div
            class="overflow-x-auto scrollbar-hide"
            style=" border-radius: 12px; padding: 8px;"
          >
            <div class="flex gap-2 justify-center min-w-max">
              {faqCategories.map(category => (
                <a
                  href={`?category_id=${category.id}`}
                  class={`tab-item px-4 py-2 rounded-lg font-medium transition-all duration-300 whitespace-nowrap text-center no-underline flex-shrink-0 border-0 cursor-pointer ${selectedCategory?.id === category.id ? 'active' : ''}`}
                  style={selectedCategory?.id === category.id ? 'background-color: var(--color-primary-500); color: white;' : 'background-color: var(--color-neutral-100); color: var(--theme-text);'}
                >
                  {category.title}
                </a>
              ))}
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- 使用 FAQ 組件 -->
    <div class="max-w-6xl mx-auto w-full">
      <!-- Loading 狀態 -->
      <div id="faq-loading" class="hidden text-center py-16">
        <div class="max-w-md mx-auto">
          <div class="mb-6">
            <div
              class="animate-spin mx-auto h-16 w-16 border-4 border-gray-200 border-t-4 border-t-blue-500 rounded-full"
            ></div>
          </div>
          <p class="text-lg" style="color: var(--theme-text-secondary);" data-i18n="faq.loading">{t('faq.loading')}</p>
        </div>
      </div>

      <!-- FAQ 內容 -->
      <div id="faq-content">
        <FAQ faqs={faqs} client:visible />
      </div>
    </div>
    </div>
  </main>
</Layout>

<style>
  .tab-item {
    transition: all 0.3s ease;
    text-decoration: none !important;
  }

  .tab-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .tab-item.active {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(var(--color-primary-500-rgb), 0.3);
  }

  /* 隱藏滾動條 */
  .scrollbar-hide {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE 10+ */
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none; /* WebKit */
  }

  /* 滾動容器優化 */
  .scrollbar-hide {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }

  /* 響應式調整 */
  @media (max-width: 640px) {
    .tab-item {
      padding: 8px 12px !important;
      font-size: 14px;
      min-width: 80px;
    }
  }

  @media (min-width: 641px) {
    .tab-item {
      padding: 10px 20px !important;
    }
  }
</style>
