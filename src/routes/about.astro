---
import {seoMeta} from '@stephenchenorg/astro/page'
import Layout from '@/layouts/Layout.astro'
import Button from '../components/ui/Button.astro'
import SectionTitle from '../components/ui/SectionTitle.astro'
import {createNestedT} from '@/utils/i18n'
import {getLocale} from 'i18n:astro'
import { getServiceCategories } from '@/api/serviceCategories'

const t = await createNestedT()
const currentLocale = getLocale()
const isEnglish = currentLocale === 'en'

const data = await getServiceCategories()
const services = data.serviceCategories.data

const meta = seoMeta({
    title: t('about.pageTitle'),
})
---

<Layout meta={meta}>
    <!-- Hero Banner -->
    <section class="relative aspect-[1920/900] sm:aspect-[1920/800] lg:aspect-[1920/700] overflow-hidden">
        <div class="absolute inset-0">
            <img
                    src="https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg"
                    alt="品牌介紹 banner"
                    class="object-cover w-full h-full"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-black/10"></div>
        </div>
        <!-- Hero Content Overlay -->
        <div class="absolute inset-0 flex items-center justify-center pt-20 pb-10">
            <div class="text-center text-white px-6 sm:px-8 lg:px-12 max-w-4xl mx-auto">
                <!-- Main Title - Center -->
                <h1 class={`font-bold leading-tight tracking-wide mb-8 sm:mb-12 animate-fade-in-up ${isEnglish ? 'text-2xl sm:text-4xl lg:text-5xl xl:text-6xl' : 'text-3xl sm:text-5xl lg:text-6xl xl:text-7xl'}`}>
                    {t('about.hero.title')}
                </h1>
            </div>
        </div>
    </section>

    <main class="section-container-detail">
        <SectionTitle title={t('about.sectionTitle')} subtitle={t('about.sectionSubtitle')}/>

        <!-- 品牌介紹內容 -->
        <section class="max-w-6xl mx-auto mb-20 sm:mb-28 px-4 sm:px-6 brand-intro-section" data-animate-in="up">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 items-center">
                <!-- 左側圖片 -->
                <div class="order-2 lg:order-1" data-animate-in="left">
                    <div class="relative aspect-[4/3] rounded-2xl overflow-hidden shadow-2xl">
                        <img
                            src="/public/images/about2.jpg"
                            alt="品牌介紹圖片"
                            class="w-full h-full object-cover"
                        />
                    </div>
                </div>

                <!-- 右側文字 -->
                <div class="order-1 lg:order-2" data-animate-in="right">
                    <h3 class={`font-bold mb-6 sm:mb-8 ${isEnglish ? 'text-2xl sm:text-3xl lg:text-4xl' : 'text-3xl sm:text-4xl lg:text-5xl'}`}
                        style="color: var(--theme-text)">{t('about.heaven.title')}</h3>
                    <div class="intro-text-container space-y-6"
                         style="color: var(--theme-text)">
                        <p class={`leading-relaxed ${isEnglish ? 'text-base sm:text-lg' : 'text-lg sm:text-xl'}`}
                           data-animate-in="up">
                            {t('about.heaven.description')}
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sticky Stacking Scroll 區域 -->
        <div class="sticky-scroll-wrapper relative">
            <!-- 左側進度指示器 -->
            <div class="fixed left-8 top-1/2 -translate-y-1/2 z-50 hidden lg:block">
                <div class="relative flex items-start">
                    <!-- 進度線 -->
                    <div class="relative w-1 bg-neutral-300 dark:bg-white/20 rounded-full flex-shrink-0" style="height: 300px;">
                        <div class="absolute top-0 left-0 w-full bg-primary-500 rounded-full transition-all duration-500 ease-out" id="progress-indicator" style="height: 0%;"></div>
                    </div>
                    <!-- 進度點和標籤容器 -->
                    <div class="absolute top-0 left-0 flex flex-col" id="progress-dots-container" style="height: 300px;">
                    </div>
                </div>
            </div>
            <!-- Section 1: 環境圖片輪播 -->
            <section class="sticky top-0 h-screen flex items-center justify-center ">
                <div class="w-full h-screen flex flex-col items-center justify-center py-16 px-6 overflow-hidden">
                    <!-- 文字描述區 -->
                    <div class="max-w-5xl mx-auto text-center mb-12 z-10">
                        <h2 class={`font-bold mb-6 leading-tight ${isEnglish ? 'text-2xl sm:text-3xl lg:text-4xl' : 'text-3xl sm:text-4xl lg:text-5xl'}`}>
                            {t('about.environment.title')}
                        </h2>
                        <p class={` mb-6 leading-relaxed ${isEnglish ? 'text-base sm:text-lg' : 'text-lg sm:text-xl'}`}>
                            {t('about.environment.description1')}
                        </p>
                        <p class={`leading-relaxed ${isEnglish ? 'text-base sm:text-lg' : 'text-lg sm:text-xl'}`}>
                            {t('about.environment.description2')}
                        </p>
                    </div>

                    <!-- 滾動驅動圖片區 -->
                    <div class="w-full flex-1 flex flex-col justify-center gap-6 overflow-hidden">
                        <div class="environment-scroll-wrapper">
                            <div class="environment-scroll-row">
                                <div class="environment-scroll-content" id="environment-scroll-1">
                                    <img src="/public/images/about3.jpeg" alt="環境圖片 1" class="environment-scroll-image" />
                                    <img src="/public/images/about4.jpeg" alt="環境圖片 2" class="environment-scroll-image" />
                                    <img src="/public/images/about5.jpeg" alt="環境圖片 3" class="environment-scroll-image" />
                                    <img src="/public/images/about6.jpeg" alt="環境圖片 4" class="environment-scroll-image" />
                                    <img src="/public/images/about3.jpeg" alt="環境圖片 5" class="environment-scroll-image" />
                                    <img src="/public/images/about4.jpeg" alt="環境圖片 6" class="environment-scroll-image" />
                                </div>
                            </div>
                        </div>
                        <div class="environment-scroll-wrapper">
                            <div class="environment-scroll-row">
                                <div class="environment-scroll-content reverse" id="environment-scroll-2">
                                    <img src="/public/images/about6.jpeg" alt="環境圖片 7" class="environment-scroll-image" />
                                    <img src="/public/images/about5.jpeg" alt="環境圖片 8" class="environment-scroll-image" />
                                    <img src="/public/images/about3.jpeg" alt="環境圖片 9" class="environment-scroll-image" />
                                    <img src="/public/images/about4.jpeg" alt="環境圖片 10" class="environment-scroll-image" />
                                    <img src="/public/images/about6.jpeg" alt="環境圖片 11" class="environment-scroll-image" />
                                    <img src="/public/images/about5.jpeg" alt="環境圖片 12" class="environment-scroll-image" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            {services.map((service, index) => (
                <section class="sticky top-0 h-screen flex flex-col md:flex-row md:items-center md:justify-end relative overflow-hidden service-section" data-service-index={index}>
                    <!-- 背景圖層 -->
                    <div class="absolute inset-0 w-full h-full bg-cover bg-center transition-transform duration-700 ease-out service-bg" style={`background-image: url(${service.cover?.desktop}); background-size: cover; background-position: center;`}></div>

                    <!-- 漸層遮罩：手機版上下漸層，桌面版左右漸層 -->
                    <div class="absolute inset-0 w-full h-full bg-gradient-to-b md:bg-gradient-to-r from-transparent via-black/30 to-black/70 transition-opacity duration-700"></div>

                    <!-- 內容區：手機版在上方，桌面版在右側 -->
                    <div class="w-full md:w-1/2 lg:w-2/5 px-6 pt-24 md:pt-0 md:px-12 lg:px-16 text-white relative z-10 service-content">
                        <div class="space-y-4 md:space-y-6">
                            <h2 class={`font-bold opacity-0 translate-y-8 transition-all duration-700 delay-150 service-title ${isEnglish ? 'text-2xl sm:text-3xl md:text-4xl lg:text-5xl' : 'text-3xl sm:text-4xl md:text-5xl lg:text-6xl'}`}>
                                {service.title}
                            </h2>
                            {service.description && (
                                <p class={`leading-relaxed opacity-0 translate-y-8 transition-all duration-700 delay-300 service-description ${isEnglish ? 'text-sm sm:text-base md:text-lg' : 'text-base sm:text-lg md:text-xl'}`}>
                                    {service.description}
                                </p>
                            )}
                            <a href={`/services/${service.id}/items`} class="inline-block mt-4 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white dark:text-black rounded-full font-medium transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg text-sm md:text-base opacity-0 translate-y-8 delay-500 service-button">
                                {isEnglish ? 'View Services' : '查看服務'}
                            </a>
                        </div>
                    </div>
                </section>
            ))}
        </div>

        <!-- 聯絡我們區域 -->
        <section class="max-w-4xl mx-auto py-16 sm:py-20 text-center" data-animate-in="fadeIn">
            <div class="space-y-8">
                <p class={`leading-relaxed text-theme-text ${isEnglish ? 'text-xl sm:text-2xl lg:text-3xl' : 'text-2xl sm:text-3xl lg:text-4xl'}`}>
                    {t('about.contact.description')}
                </p>
                <Button
                    href="/joinUs/careers"
                    variant="outline"
                    size="large"
                    text={t('about.contact.buttonText')}
                />
            </div>
        </section>
    </main>
</Layout>

<style>
    /* 動畫初始狀態 - 確保版面一開始就正常顯示 */
    [data-animate-in] {
        opacity: 1;
        transform: none;
        transition: all 0.6s ease-out;
    }

    /* 動畫準備狀態 */
    [data-animate-in]:not(.in-view) {
        opacity: 0;
    }

    [data-animate-in="up"]:not(.in-view) {
        transform: translateY(30px);
    }

    [data-animate-in="left"]:not(.in-view) {
        transform: translateX(-30px);
    }

    [data-animate-in="right"]:not(.in-view) {
        transform: translateX(30px);
    }

    [data-animate-in="fadeIn"]:not(.in-view) {
        opacity: 0;
    }

    [data-animate-in="scaleIn"]:not(.in-view) {
        transform: scale(0.95);
    }

    /* 動畫執行狀態 */
    [data-animate-in].in-view {
        opacity: 1;
        transform: none;
    }

    /* 輪播導航按鈕垂直置中 - 針對 services-carousel */
    .services-carousel-container {
        position: relative;
    }

    .services-carousel-container .carousel-prev,
    .services-carousel-container .carousel-next {
        top: 50% !important;
        transform: translateY(-50%) !important;
    }

    /* 使用 JavaScript 動態計算中心位置 */
    .services-carousel-container .carousel-prev,
    .services-carousel-container .carousel-next {
        position: absolute !important;
        z-index: 20 !important;
    }

    /* intro 文字段落階段式動畫 */
    .intro-text-container p[data-animate-in]:nth-child(1) {
        animation-delay: 0.2s;
    }

    .intro-text-container p[data-animate-in]:nth-child(2) {
        animation-delay: 0.4s;
    }

    .intro-text-container p[data-animate-in]:nth-child(3) {
        animation-delay: 0.6s;
    }

    /* 為 intro 文字添加特殊過渡效果 */
    .intro-text-container p[data-animate-in] {
        transition-delay: 0s;
    }

    .intro-text-container p[data-animate-in]:nth-child(1).in-view {
        transition-delay: 0.2s;
    }

    .intro-text-container p[data-animate-in]:nth-child(2).in-view {
        transition-delay: 0.4s;
    }

    .intro-text-container p[data-animate-in]:nth-child(3).in-view {
        transition-delay: 0.6s;
    }

    /* English language optimizations for About page */
    .about-en-text {
        word-break: break-word;
        hyphens: auto;
        letter-spacing: 0.025em;
    }

    /* Hero title adjustments for English */
    .about-hero-en {
        line-height: 1.1;
        letter-spacing: -0.01em;
    }

    /* Service carousel text adjustments for English */
    .about-service-en h4 {
        line-height: 1.3;
        word-break: break-word;
    }

    .about-service-en p {
        line-height: 1.4;
        word-break: break-word;
    }

    /* Environment section adjustments for English */
    .about-environment-en {
        word-spacing: 0.1em;
        line-height: 1.4;
    }

    /* Contact section adjustments for English */
    .about-contact-en {
        line-height: 1.3;
        word-break: break-word;
    }

    /* Responsive adjustments for English content */
    @media (max-width: 768px) {
        .about-hero-en {
            font-size: 1.5rem;
            line-height: 1.2;
        }

        .about-service-en h4 {
            font-size: 1rem;
            line-height: 1.3;
        }

        .about-service-en p {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .about-environment-en {
            font-size: 1rem;
            line-height: 1.4;
        }

        .about-contact-en {
            font-size: 1.125rem;
            line-height: 1.3;
        }
    }

    /* Service card background image optimization */
    .service-card {
        min-height: 400px;
    }

    .service-background {
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    /* Specific width handling for 1583px and similar resolutions */
    @media (min-width: 1500px) and (max-width: 1650px) {
        .service-background {
            width: 138% !important;
            transform: translateX(-8%);
        }

        .service-background:hover {
            transform: translateX(-32%) !important;
        }
    }

    @media (min-width: 1400px) and (max-width: 1499px) {
        .service-background {
            width: 135% !important;
            transform: translateX(-5%);
        }

        .service-background:hover {
            transform: translateX(-30%) !important;
        }
    }

    @media (min-width: 1651px) and (max-width: 1700px) {
        .service-background {
            width: 136% !important;
            transform: translateX(-6%);
        }

        .service-background:hover {
            transform: translateX(-31%) !important;
        }
    }

    /* For very wide screens */
    @media (min-width: 1700px) {
        .service-background {
            width: 140% !important;
            transform: translateX(-10%);
        }

        .service-background:hover {
            transform: translateX(-35%) !important;
        }
    }

    /* Ensure no gaps on medium-large screens */
    @media (min-width: 1200px) and (max-width: 1399px) {
        .service-background {
            width: 135% !important;
            transform: translateX(-10%);
        }

        .service-background:hover {
            transform: translateX(-28%) !important;
        }
    }

    @media (min-width: 1024px) and (max-width: 1199px) {
        .service-background {
            width: 140% !important;
            transform: translateX(-15%);
        }

        .service-background:hover {
            transform: translateX(-35%) !important;
        }
    }

    /* For smaller desktop screens */
    @media (min-width: 768px) and (max-width: 1023px) {
        .service-background {
            width: 145% !important;
            transform: translateX(-20%);
        }

        .service-background:hover {
            transform: translateX(-40%) !important;
        }
    }

    /* Environment Scroll 樣式 - 跟隨滾動 */
    .environment-scroll-wrapper {
        width: 100%;
        overflow: hidden;
        position: relative;
    }

    .environment-scroll-row {
        width: 100%;
        height: 320px;
        position: relative;
        overflow: hidden;
    }

    .environment-scroll-content {
        display: flex;
        gap: 24px;
        will-change: transform;
        transform: translate3d(0, 0, 0);
        transition: transform 0.1s linear;
    }

    .environment-scroll-image {
        flex-shrink: 0;
        width: 490px;
        height: 320px;
        object-fit: cover;
        border-radius: 24px;
        transition: all 0.3s ease;
    }

    .environment-scroll-image:hover {
        transform: scale(1.05);
        z-index: 10;
        position: relative;
    }

    /* 響應式設計 */
    @media (max-width: 768px) {
        .environment-scroll-row {
            height: 230px;
        }

        .environment-scroll-image {
            width: 350px;
            height: 230px;
        }
    }

    @media (max-width: 480px) {
        .environment-scroll-row {
            height: 180px;
        }

        .environment-scroll-image {
            width: 280px;
            height: 180px;
        }
    }

    /* Sticky Stacking Scroll 樣式 */
    .sticky-scroll-wrapper {
        position: relative;
        width: 100%;
    }

    .sticky-scroll-wrapper section {
        width: 100%;
    }
</style>

<script>
    // 動畫觀察器初始化
    function initializeAnimations() {
        const animatedElements = document.querySelectorAll('[data-animate-in]')

        if (!animatedElements.length) return

        // 先將所有動畫元素設為可見狀態，避免初始載入時的版面問題
        animatedElements.forEach(element => {
            const el = element as HTMLElement
            el.style.opacity = '1'
            el.style.transform = 'none'
        })

        // 延遲一段時間後開始動畫觀察
        setTimeout(() => {
            // 重新設定初始狀態
            animatedElements.forEach(element => {
                if (!element.classList.contains('in-view')) {
                    const el = element as HTMLElement
                    const animationType = element.getAttribute('data-animate-in')

                    switch (animationType) {
                        case 'up':
                            el.style.opacity = '0'
                            el.style.transform = 'translateY(30px)'
                            break
                        case 'left':
                            el.style.opacity = '0'
                            el.style.transform = 'translateX(-30px)'
                            break
                        case 'right':
                            el.style.opacity = '0'
                            el.style.transform = 'translateX(30px)'
                            break
                        case 'fadeIn':
                            el.style.opacity = '0'
                            break
                        case 'scaleIn':
                            el.style.opacity = '0'
                            el.style.transform = 'scale(0.95)'
                            break
                        default:
                            el.style.opacity = '0'
                    }
                }
            })

            const observer = new IntersectionObserver(
                entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // 檢查是否是 intro 文字段落
                            const isIntroText = entry.target.closest('.intro-text-container')

                            if (isIntroText) {
                                // 階段式觸發 intro 文字動畫
                                const container = entry.target.closest('.intro-text-container')
                                if (container) {
                                    const paragraphs = container.querySelectorAll('p[data-animate-in]')

                                    paragraphs.forEach((p, index) => {
                                        setTimeout(() => {
                                            p.classList.add('in-view')
                                            const pEl = p as HTMLElement
                                            pEl.style.opacity = '1'
                                            pEl.style.transform = 'none'
                                        }, index * 200) // 每個段落延遲 200ms
                                    })

                                    // 取消觀察所有 intro 段落
                                    paragraphs.forEach(p => observer.unobserve(p))
                                }
                            } else {
                                // 一般動畫元素
                                entry.target.classList.add('in-view')
                                const targetEl = entry.target as HTMLElement
                                targetEl.style.opacity = '1'
                                targetEl.style.transform = 'none'
                                observer.unobserve(entry.target)
                            }
                        }
                    })
                },
                {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px',
                }
            )

            animatedElements.forEach(element => {
                observer.observe(element)
            })
        }, 100) // 延遲 100ms 開始動畫
    }

    // 頁面載入完成後初始化動畫
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeAnimations, 50)
        })
    } else {
        setTimeout(initializeAnimations, 50)
    }

    // 備用初始化
    window.addEventListener('load', () => {
        setTimeout(initializeAnimations, 100)
    })

    // 輪播按鈕垂直置中功能
    function centerCarouselButtons() {
        const carousel = document.querySelector('.services-carousel-carousel')
        if (!carousel) {
            setTimeout(centerCarouselButtons, 500)
            return
        }

        const prevBtn = carousel.querySelector('.carousel-prev')
        const nextBtn = carousel.querySelector('.carousel-next')
        const slides = carousel.querySelectorAll('.carousel-slide')

        if (!prevBtn || !nextBtn || !slides.length) {
            setTimeout(centerCarouselButtons, 500)
            return
        }

        // 計算輪播內容的中心位置
        function updateButtonPositions() {
            if (!carousel) return
            const carouselRect = carousel.getBoundingClientRect()
            const firstSlide = slides[0]

            if (firstSlide) {
                const slideRect = firstSlide.getBoundingClientRect()
                const slideCenter = slideRect.top + slideRect.height / 2 - carouselRect.top

                // 設置按鈕位置
                if (prevBtn) {
                    const prevBtnElement = prevBtn as HTMLElement
                    prevBtnElement.style.top = `${slideCenter}px`
                    prevBtnElement.style.transform = 'translateY(-50%)'
                }
                if (nextBtn) {
                    const nextBtnElement = nextBtn as HTMLElement
                    nextBtnElement.style.top = `${slideCenter}px`
                    nextBtnElement.style.transform = 'translateY(-50%)'
                }
            }
        }

        // 初始設置
        updateButtonPositions()

        // 監聽窗口調整大小
        const resizeObserver = new ResizeObserver(updateButtonPositions)
        resizeObserver.observe(carousel)

        // 監聽窗口大小變化
        window.addEventListener('resize', updateButtonPositions)
    }

    // 初始化按鈕置中
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(centerCarouselButtons, 1000)
        })
    } else {
        setTimeout(centerCarouselButtons, 1000)
    }

    // 備用初始化
    window.addEventListener('load', () => {
        setTimeout(centerCarouselButtons, 1500)
    })

    // 環境圖片跟隨滾動功能
    function initEnvironmentScrollEffect() {
        const scroll1 = document.getElementById('environment-scroll-1')
        const scroll2 = document.getElementById('environment-scroll-2')

        if (!scroll1 || !scroll2) return

        // 找到環境區塊的 section
        const environmentSection = scroll1.closest('section')
        if (!environmentSection) return

        // 設置第二排圖片的初始位置（從右邊開始）
        const containerWidth = scroll2.scrollWidth / 2
        scroll2.style.transform = `translate3d(-${containerWidth}px, 0px, 0px)`

        let lastScrollY = window.scrollY

        function handleScroll() {
            if (!scroll1 || !scroll2 || !environmentSection) return

            const currentScrollY = window.scrollY
            const scrollDelta = currentScrollY - lastScrollY

            // 檢查環境區塊是否在可視範圍內
            const rect = environmentSection.getBoundingClientRect()
            const isVisible = rect.top < window.innerHeight && rect.bottom > 0

            // 只有在環境區塊可見時才移動圖片
            if (!isVisible) {
                lastScrollY = currentScrollY
                return
            }

            // 獲取當前的 transform 值
            const transform1 = scroll1.style.transform || 'translate3d(0px, 0px, 0px)'
            const transform2 = scroll2.style.transform || 'translate3d(0px, 0px, 0px)'

            // 提取當前的 x 位移值
            const match1 = transform1.match(/translate3d\(([^,]+)/)
            const match2 = transform2.match(/translate3d\(([^,]+)/)

            const currentX1 = match1 ? parseFloat(match1[1]) : 0
            const currentX2 = match2 ? parseFloat(match2[1]) : 0

            // 計算新的位移（第一行向左，第二行向右）
            const speed = 0.15 // 降低滾動速度倍數
            const newX1 = currentX1 - (scrollDelta * speed)
            const newX2 = currentX2 + (scrollDelta * speed)

            // 計算容器寬度進行循環
            const containerWidth = scroll1.scrollWidth / 2

            // 循環邏輯 - 第一排向左滾動
            let finalX1 = newX1
            if (newX1 < -containerWidth) {
                finalX1 = 0
            } else if (newX1 > 0) {
                finalX1 = -containerWidth
            }

            // 循環邏輯 - 第二排向右滾動（反向）
            let finalX2 = newX2
            if (newX2 > 0) {
                finalX2 = -containerWidth
            } else if (newX2 < -containerWidth) {
                finalX2 = 0
            }

            // 應用新的 transform
            scroll1.style.transform = `translate3d(${finalX1}px, 0px, 0px)`
            scroll2.style.transform = `translate3d(${finalX2}px, 0px, 0px)`

            lastScrollY = currentScrollY
        }

        // 監聽滾動事件
        window.addEventListener('scroll', handleScroll, { passive: true })
    }

    // 初始化環境滾動效果
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEnvironmentScrollEffect)
    } else {
        initEnvironmentScrollEffect()
    }

    // 服務區塊動畫效果
    function initServiceAnimations() {
        const serviceSections = document.querySelectorAll('.service-section')

        const observerOptions = {
            threshold: 0.3,
            rootMargin: '0px'
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const section = entry.target as HTMLElement

                    // 背景放大效果
                    const bg = section.querySelector('.service-bg') as HTMLElement
                    if (bg) {
                        bg.style.transform = 'scale(1.05)'
                    }

                    // 標題動畫
                    const title = section.querySelector('.service-title') as HTMLElement
                    if (title) {
                        setTimeout(() => {
                            title.style.opacity = '1'
                            title.style.transform = 'translateY(0)'
                        }, 150)
                    }

                    // 描述動畫
                    const description = section.querySelector('.service-description') as HTMLElement
                    if (description) {
                        setTimeout(() => {
                            description.style.opacity = '1'
                            description.style.transform = 'translateY(0)'
                        }, 300)
                    }

                    // 按鈕動畫
                    const button = section.querySelector('.service-button') as HTMLElement
                    if (button) {
                        setTimeout(() => {
                            button.style.opacity = '1'
                            button.style.transform = 'translateY(0)'
                        }, 500)
                    }
                } else {
                    // 離開可視範圍時重置
                    const section = entry.target as HTMLElement

                    const bg = section.querySelector('.service-bg') as HTMLElement
                    if (bg) {
                        bg.style.transform = 'scale(1)'
                    }

                    const title = section.querySelector('.service-title') as HTMLElement
                    if (title) {
                        title.style.opacity = '0'
                        title.style.transform = 'translateY(32px)'
                    }

                    const description = section.querySelector('.service-description') as HTMLElement
                    if (description) {
                        description.style.opacity = '0'
                        description.style.transform = 'translateY(32px)'
                    }

                    const button = section.querySelector('.service-button') as HTMLElement
                    if (button) {
                        button.style.opacity = '0'
                        button.style.transform = 'translateY(32px)'
                    }
                }
            })
        }, observerOptions)

        serviceSections.forEach(section => {
            observer.observe(section)
        })
    }

    // 初始化服務動畫
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initServiceAnimations)
    } else {
        initServiceAnimations()
    }

    // 進度指示器功能
    function initProgressIndicator() {
        const progressIndicator = document.getElementById('progress-indicator')
        const progressDotsContainer = document.getElementById('progress-dots-container')
        const brandIntroSection = document.querySelector('.brand-intro-section')
        const serviceSections = document.querySelectorAll('.service-section')
        const stickyWrapper = document.querySelector('.sticky-scroll-wrapper')
        const environmentSection = document.querySelector('.sticky-scroll-wrapper > section:first-of-type')

        if (!progressIndicator || !progressDotsContainer || !stickyWrapper) return

        // 收集所有區塊標題（品牌介紹 + 環境 + 服務）
        const sections = [brandIntroSection, environmentSection, ...Array.from(serviceSections)]
        const sectionTitles = sections.map((section, index) => {
            if (index === 0) {
                // 品牌介紹區塊
                const title = section?.querySelector('h3')?.textContent?.trim() || '品牌介紹'
                return title
            } else if (index === 1) {
                // 環境區塊
                const title = section?.querySelector('h2')?.textContent?.trim() || '環境介紹'
                return title
            } else {
                // 服務區塊
                const title = section?.querySelector('.service-title')?.textContent?.trim() || `服務 ${index - 1}`
                return title
            }
        })

        // 生成進度點和標籤
        const totalSections = sections.length
        const itemHeight = 300 / (totalSections - 1) // 均勻分佈

        const dotsHTML = sectionTitles.map((title, index) => {
            const topPosition = index * itemHeight
            return `
                <div class="absolute flex items-center gap-3 cursor-pointer group progress-item"
                     data-index="${index}"
                     style="top: ${topPosition}px; left: -4px; transform: translateY(-50%);">
                    <!-- 進度點 -->
                    <div class="w-3 h-3 rounded-full border-2 border-neutral-400 dark:border-white/40 bg-transparent transition-all duration-300 progress-dot group-hover:scale-150 group-hover:border-primary-400" style="flex-shrink: 0;"></div>
                    <!-- 標籤文字 -->
                    <span class="text-sm font-medium text-neutral-600 dark:text-white/60 whitespace-nowrap transition-all duration-300 group-hover:text-primary-500 group-hover:translate-x-1 progress-label">
                        ${title}
                    </span>
                </div>
            `
        }).join('')

        progressDotsContainer.innerHTML = dotsHTML
        const dots = progressDotsContainer.querySelectorAll('.progress-dot')
        const labels = progressDotsContainer.querySelectorAll('.progress-label')
        const items = progressDotsContainer.querySelectorAll('.progress-item')

        function updateProgress() {
            if (!progressIndicator || !stickyWrapper) return

            let currentSectionIndex = 0

            // 檢查是否在品牌介紹區塊
            if (brandIntroSection) {
                const brandRect = brandIntroSection.getBoundingClientRect()
                if (brandRect.top <= window.innerHeight / 2 && brandRect.bottom >= window.innerHeight / 2) {
                    currentSectionIndex = 0
                    progressIndicator.style.height = `${(1 / totalSections) * 100}%`
                } else if (brandRect.bottom < window.innerHeight / 2) {
                    // 已經滾過品牌介紹，計算 sticky wrapper 進度
                    const wrapperRect = stickyWrapper.getBoundingClientRect()
                    const wrapperHeight = stickyWrapper.scrollHeight
                    const scrollProgress = Math.max(0, -wrapperRect.top)
                    const wrapperProgress = Math.min(1, scrollProgress / (wrapperHeight - window.innerHeight))

                    // 進度線：品牌介紹 + wrapper 進度
                    const totalProgressValue = (1 + wrapperProgress * (totalSections - 1)) / totalSections
                    progressIndicator.style.height = `${totalProgressValue * 100}%`

                    // 當前區塊：1 (環境) + wrapper 內的進度
                    currentSectionIndex = Math.min(
                        1 + Math.floor(wrapperProgress * (totalSections - 1)),
                        totalSections - 1
                    )
                } else {
                    // 還沒到品牌介紹
                    progressIndicator.style.height = '0%'
                    currentSectionIndex = -1
                }
            } else {
                // 沒有品牌介紹，使用原邏輯
                const wrapperRect = stickyWrapper.getBoundingClientRect()
                const wrapperHeight = stickyWrapper.scrollHeight
                const scrollProgress = Math.max(0, -wrapperRect.top)
                const totalProgress = Math.min(1, scrollProgress / (wrapperHeight - window.innerHeight))

                progressIndicator.style.height = `${totalProgress * 100}%`
                currentSectionIndex = Math.min(
                    Math.floor(totalProgress * totalSections),
                    totalSections - 1
                )
            }

            // 檢測是否為深色模式
            const isDarkMode = document.documentElement.classList.contains('dark')

            // 更新進度點和標籤狀態
            dots.forEach((dot, index) => {
                const dotElement = dot as HTMLElement
                const labelElement = labels[index] as HTMLElement

                if (index <= currentSectionIndex) {
                    dotElement.style.backgroundColor = '#d4af37' // primary-500
                    dotElement.style.borderColor = '#d4af37'
                    if (index === currentSectionIndex) {
                        dotElement.style.transform = 'scale(1.3)'
                        labelElement.style.color = '#d4af37'
                        labelElement.style.fontWeight = '600'
                    } else {
                        dotElement.style.transform = 'scale(1.1)'
                        labelElement.style.color = isDarkMode ? 'rgba(255, 255, 255, 0.8)' : 'rgba(64, 64, 64, 0.8)'
                        labelElement.style.fontWeight = '500'
                    }
                } else {
                    dotElement.style.backgroundColor = 'transparent'
                    dotElement.style.borderColor = isDarkMode ? 'rgba(255, 255, 255, 0.4)' : 'rgba(163, 163, 163, 0.6)'
                    dotElement.style.transform = 'scale(1)'
                    labelElement.style.color = isDarkMode ? 'rgba(255, 255, 255, 0.6)' : 'rgba(82, 82, 82, 0.8)'
                    labelElement.style.fontWeight = '500'
                }
            })
        }

        // 點擊跳轉功能
        items.forEach((item, index) => {
            item.addEventListener('click', () => {
                const targetSection = sections[index]
                if (targetSection) {
                    let targetScroll = 0

                    if (index === 0) {
                        // 品牌介紹區塊：滾動到 SectionTitle 上方
                        const sectionTitle = document.querySelector('.section-container-detail')
                        if (sectionTitle) {
                            targetScroll = sectionTitle.getBoundingClientRect().top + window.scrollY - 80
                        } else {
                            targetScroll = targetSection.getBoundingClientRect().top + window.scrollY - 100
                        }
                    } else if (index === 1) {
                        // 環境區塊：滾動到 sticky wrapper 開始位置
                        targetScroll = stickyWrapper.getBoundingClientRect().top + window.scrollY
                    } else {
                        // 其他服務區塊
                        const wrapperTop = stickyWrapper.getBoundingClientRect().top + window.scrollY
                        const sectionHeight = window.innerHeight
                        // index - 1 因為要扣掉品牌介紹
                        targetScroll = wrapperTop + ((index - 1) * sectionHeight)
                    }

                    // 平滑滾動到目標位置
                    window.scrollTo({
                        top: targetScroll,
                        behavior: 'smooth'
                    })
                }
            })
        })

        // 監聽滾動
        window.addEventListener('scroll', updateProgress, { passive: true })
        updateProgress() // 初始化
    }

    // 初始化進度指示器
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initProgressIndicator)
    } else {
        initProgressIndicator()
    }
</script>
