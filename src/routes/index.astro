---
import type { PageMeta } from '@stephenchenorg/astro/page'
import { seoMeta } from '@stephenchenorg/astro/page'
import { getLocale } from 'i18n:astro'
import { getArticles } from '@/api/articles'
import { getBanners } from '@/api/banners'
import { getServiceCategories } from '@/api/serviceCategories'
import { getAllTeams } from '@/api/teams'
import HeroBanner from '@/components/HeroBanner.astro'
import IndexNews from '@/components/IndexNews.astro'
import ServiceSection from '@/components/ServiceSection.astro'
import TeamSection from '@/components/TeamSection.astro'
import Layout from '@/layouts/Layout.astro'
import { getCanonicalUrl, getSeoConfig } from '@/utils/seoConfig'
import IntroSection from '../components/IntroSection.astro'

const currentLocale = getLocale()
const locale = currentLocale === 'en' ? 'en' : 'zh_TW'

// ä¸¦è¡Œå‘¼å«æ‰€æœ‰ GraphQL APIï¼Œå¤§å¹…æå‡è¼‰å…¥é€Ÿåº¦
const startTime = performance.now()

const [banners, allTeams, serviceData, allArticles] = await Promise.all([
  getBanners().then(data => {
    const time = performance.now() - startTime
    console.log(`âœ… getBanners() completed in ${time.toFixed(2)}ms`)
    return data
  }),
  getAllTeams(40).then(data => {
    const time = performance.now() - startTime
    console.log(`âœ… getAllTeams() completed in ${time.toFixed(2)}ms`)
    return data
  }),
  getServiceCategories().then(data => {
    const time = performance.now() - startTime
    console.log(`âœ… getServiceCategories() completed in ${time.toFixed(2)}ms`)
    return data
  }),
  getArticles().then(data => {
    const time = performance.now() - startTime
    console.log(`âœ… getArticles() completed in ${time.toFixed(2)}ms`)
    return data
  }),
])

const totalTime = performance.now() - startTime
console.log(`\nğŸš€ Total API time (parallel): ${totalTime.toFixed(2)}ms\n`)

// è™•ç†è³‡æ–™
const teamMembers = allTeams.slice(0, 6)
const services = serviceData.serviceCategories.data
const articles = allArticles.slice(0, 6)

// å–å¾— SEO è¨­å®š
const seoConfig = getSeoConfig('home', locale)

const meta = {
  ...seoMeta(seoConfig),
  canonical: getCanonicalUrl('', locale),
} as PageMeta
---

<Layout meta={meta}>
  <!-- Hero Banner -->
  <HeroBanner banners={banners} />
  <IntroSection />

  <div class="animate-in">
    <TeamSection teamMembers={teamMembers} />
  </div>

  <div class="animate-in">
    <ServiceSection services={services} />
  </div>

  <div class="animate-in">
    <IndexNews articles={articles} />
  </div>

  <script>
    // ç­‰å¾… DOM è¼‰å…¥å®Œæˆ
    document.addEventListener('DOMContentLoaded', () => {
      // å †ç–Šå¡ç‰‡æ•ˆæœ
      const stackCards = document.querySelectorAll('.stack-card') as NodeListOf<HTMLElement>

      const stackObserver = new IntersectionObserver(entries => {
        entries.forEach((entry, _index) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active')
          } else {
            entry.target.classList.remove('active')
          }
        })
      }, {
        threshold: 0.3,
        rootMargin: '-50px 0px -50px 0px',
      })

      stackCards.forEach(card => stackObserver.observe(card))

      // å¹³æ»‘æ»¾å‹•æ•ˆæœ
      const scrollLinks = document.querySelectorAll('a[href^="#"]') as NodeListOf<HTMLAnchorElement>
      scrollLinks.forEach(anchor => {
        anchor.addEventListener('click', function (e: Event) {
          e.preventDefault()
          const href = (this as HTMLAnchorElement).getAttribute('href')
          const target = href ? document.querySelector(href) : null
          if (target) {
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start',
            })
          }
        })
      })

      // è¦–å·®æ»¾å‹•æ•ˆæœ
      window.addEventListener('scroll', () => {
        const scrolled = window.pageYOffset
        const heroImage = document.querySelector('.hero-image') as HTMLElement
        if (heroImage) {
          heroImage.style.transform = `translateY(${scrolled * 0.5}px)`
        }
      })
    })
  </script>
</Layout>
