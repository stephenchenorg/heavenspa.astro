---
import { seoMeta } from '@stephenchenorg/astro/page'
import SectionTitle from '@/components/ui/SectionTitle.astro'
import Layout from '@/layouts/Layout.astro'
import FAQ from '@/components/FAQ.astro'
import { getFaqList, getFaqCategories } from '@/api/faq'

const meta = seoMeta({
  title: '常見問題 - Heaven Spa',
  description: '查看 Heaven Spa 的常見問題解答，了解我們的服務、預約流程、政策等相關資訊。',
})

// 定義類型
interface FaqItem {
  id: string
  question: string
  answer: string
}

interface ApiFaqItem {
  id: number
  title: string
  content: string
}

interface FaqCategory {
  id: number
  title: string
}

// 獲取網址參數中的分類 ID
const url = new URL(Astro.request.url)
const categoryId = url.searchParams.get('category_id')
const selectedCategoryId = categoryId ? parseInt(categoryId) : null

let faqCategories: FaqCategory[] = []
let selectedCategoryData: ApiFaqItem[] = []
let selectedCategory: FaqCategory | null = null

try {
  // 獲取分類列表
  faqCategories = await getFaqCategories()
  
  // 如果有指定分類 ID，載入該分類的資料
  if (selectedCategoryId && faqCategories.length > 0) {
    selectedCategory = faqCategories.find(cat => cat.id === selectedCategoryId) || null
    if (selectedCategory) {
      selectedCategoryData = await getFaqList(selectedCategoryId)
    }
  }
  
  // 如果沒有指定分類或找不到分類，使用第一個分類
  if (!selectedCategory && faqCategories.length > 0) {
    selectedCategory = faqCategories[0]
    selectedCategoryData = await getFaqList(selectedCategory.id)
  }
} catch (error) {
  console.error('Error fetching FAQ data:', error)
}

// 將 API 資料轉換為 FAQ 組件需要的格式
const faqData: Record<string, FaqItem[]> = {}

if (selectedCategory && selectedCategoryData.length > 0) {
  faqData[selectedCategory.title] = selectedCategoryData.map((faq: ApiFaqItem) => ({
    id: `faq-${faq.id}`,
    question: faq.title,
    answer: faq.content
  }))
} else {
  // 如果無法獲取分類，使用備用資料
  faqData['常見問題'] = [
    {
      id: 'fallback-1',
      question: '需要預約嗎？',
      answer: '是的，本店採用全預約制服務系統。請透過官方 Line 或電話提前預約，以確保能為您安排最佳的服務時段。'
    },
    {
      id: 'fallback-2',
      question: 'Heaven Spa 提供什麼類型的服務？',
      answer: '我們提供專業的 SPA 按摩服務，結合中式指壓和精油按摩技法，以及專業除毛服務，為您帶來全面的身心放鬆體驗。'
    },
    {
      id: 'fallback-3',
      question: '如何聯繫預約？',
      answer: '您可以透過官方 Line 預約系統或撥打我們的服務專線進行預約。我們的專業顧問會協助您選擇最適合的服務項目和時間。'
    },
    {
      id: 'fallback-4',
      question: '付費方式有哪些？',
      answer: '目前我們接受現金付費，暫不提供信用卡服務。我們也提供會員儲值服務，讓您享受更便利的付費體驗。'
    },
    {
      id: 'fallback-5',
      question: '服務環境如何？',
      answer: '我們提供私密、舒適的服務環境，每個房間都經過精心設計，確保您的隱私和舒適感。所有設施都定期消毒，維持最高的衛生標準。'
    }
  ]
}
---

<Layout meta={meta}>
  <main class="section-container pt-32 min-h-screen">
    <!-- 標題區 -->
    <SectionTitle title="常見問題" subtitle="FAQ" />

    <!-- Tab Navigation -->
    {faqCategories.length > 1 && (
      <div class="max-w-4xl mx-auto mb-8">
        <div
          class="flex flex-wrap justify-center gap-2 p-2 rounded-xl min-w-[600px]"
          style="background-color: var(--color-neutral-100);"
        >
          {faqCategories.map(category => (
            <a
              href={`/faq?category_id=${category.id}`}
              class={`tab-button px-6 py-3 rounded-lg font-medium transition-all duration-300 flex-1 min-w-0 text-center no-underline ${selectedCategory?.id === category.id ? 'active' : ''}`}
              data-category-id={category.id}
              style={selectedCategory?.id === category.id ? "background-color: var(--color-primary-500); color: white;" : "color: var(--theme-text);"}
            >
              {category.title}
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- 使用 FAQ 組件 -->
    <div class="max-w-6xl mx-auto w-full">
      <FAQ faqData={faqData} />
    </div>
  </main>
</Layout>

<style>
  .tab-button {
    transition: all 0.3s ease;
    text-decoration: none !important;
  }

  .tab-button:hover:not(.active) {
    background-color: var(--color-primary-100);
  }

  .tab-button.active {
    background-color: var(--color-primary-500);
    color: white !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* Responsive tabs for mobile */
  @media (max-width: 640px) {
    .tab-button {
      font-size: 0.875rem;
      padding: 0.75rem 1rem;
    }
  }
</style>
