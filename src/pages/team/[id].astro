---
import { seoMeta } from '@stephenchenorg/astro/page'
import Layout from '@/layouts/Layout.astro'
import Badge from '@/components/ui/Badge.astro'
import Schedule from '@/components/ui/Schedule.astro'
import { getAllTeams } from '@/api/teams'
import type { TeamMember } from '@/types'

// 獲取 ID 參數
const { id } = Astro.params
if (!id || isNaN(Number(id))) {
  return Astro.rewrite('/404')
}

// 獲取所有團隊成員並找到指定的成員
let teamMember: TeamMember | null = null

try {
  const allTeamMembers = await getAllTeams()
  teamMember = allTeamMembers.find(member => member.id === Number(id)) || null

  if (!teamMember) {
    return Astro.rewrite('/404')
  }
} catch (error) {
  console.error('Failed to fetch team member:', error)
  return Astro.rewrite('/404')
}

const meta = seoMeta({
  title: `${teamMember.title} - Heaven Spa`,
  description: `了解更多關於 ${teamMember.title} 的專業服務和經驗。`,
})

// 獲取有效的圖片列表
const validImages = teamMember.images?.filter(img => img.image?.desktop) || []
const mainImage = teamMember.image?.desktop || validImages[0]?.image?.desktop || '/placeholder.jpg'
---

<Layout meta={meta}>
  <main class="section-container pt-24 md:pt-32 pb-16 bg-[var(--theme-bg,#ffffff)] text-[var(--theme-text,#1f2937)]">
    <div class="flex flex-col lg:flex-row items-start gap-6 lg:gap-8 max-w-6xl mx-auto px-4 sm:px-6">
      <!-- 左側：圖片輪播 -->
      <div class="flex flex-col items-center w-full lg:w-5/12">
        <!-- 主圖輪播區域 -->
        <div class="relative w-full aspect-square max-w-md mx-auto overflow-hidden rounded-2xl border-2 shadow-lg bg-[var(--theme-card-bg,#ffffff)] border-[var(--theme-border,#e5e7eb)]">
          {validImages.length > 1 && (
            <>
              <button
                type="button"
                class="absolute left-3 top-1/2 -translate-y-1/2 z-10 bg-[var(--theme-card-bg,#ffffff)]/90 hover:bg-[var(--theme-card-bg,#ffffff)] rounded-full p-2 shadow-md transition-all duration-200 text-[var(--theme-text,#1f2937)]"
                onclick="carouselPrev()"
                aria-label="上一張"
              >
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <button
                type="button"
                class="absolute right-3 top-1/2 -translate-y-1/2 z-10 bg-[var(--theme-card-bg,#ffffff)]/90 hover:bg-[var(--theme-card-bg,#ffffff)] rounded-full p-2 shadow-md transition-all duration-200 text-[var(--theme-text,#1f2937)]"
                onclick="carouselNext()"
                aria-label="下一張"
              >
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            </>
          )}

          <img
            id="carousel-img"
            src={mainImage}
            alt={teamMember.title}
            class="w-full h-full object-cover select-none transition-all duration-300"
            loading="lazy"
          />

          {validImages.length > 1 && (
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2" id="carousel-dots">
              {validImages.map((_, idx) => (
                <button
                  type="button"
                  class={`w-2.5 h-2.5 rounded-full transition-all duration-200 ${
                    idx === 0
                      ? 'bg-[var(--color-primary-500,#3b82f6)] shadow-lg'
                      : 'bg-[var(--theme-card-bg,#ffffff)]/60 hover:bg-[var(--theme-card-bg,#ffffff)]/80'
                  }`}
                  data-idx={idx}
                  onclick={`carouselThumb(${idx})`}
                >
                </button>
              ))}
            </div>
          )}
        </div>

        <!-- 縮圖預覽 -->
        {validImages.length > 1 && (
          <div id="carousel-thumbs" class="flex flex-wrap justify-center gap-3 mt-6 max-w-md">
            {validImages.map((img, idx) => (
              <img
                src={img.image?.desktop}
                alt={`縮圖${idx+1}`}
                class={`w-20 h-20 object-cover rounded-lg border-2 cursor-pointer transition-all duration-200 shadow-sm ${
                  idx === 0
                    ? 'border-[var(--color-primary-500,#3b82f6)] ring-2 ring-[var(--color-primary-200,#bfdbfe)]'
                    : 'border-[var(--theme-border,#e5e7eb)] hover:border-[var(--theme-text-secondary,#6b7280)] hover:shadow-md'
                }`}
                onclick={`carouselThumb(${idx})`}
                loading="lazy"
              />
            ))}
          </div>
        )}

        <!-- 標籤 -->
        {teamMember.tags?.data?.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-6 w-full max-w-md">
            {teamMember.tags.data.map((tag) => (
              <Badge variant="primary" title={tag.title} />
            ))}
          </div>
        )}
      </div>

      <!-- 右側：成員資訊 -->
      <div class="flex-1 flex flex-col items-start lg:w-7/12">
        <h1 class="font-bold text-3xl md:text-4xl mb-3 leading-tight text-[var(--theme-text,#1f2937)]">
          {teamMember.title}
        </h1>

        {teamMember.category?.title && (
          <div class="text-lg mb-4 font-medium text-[var(--theme-text-secondary,#6b7280)]">
            {teamMember.category.title}
          </div>
        )}

        <!-- 工作內容/介紹 -->
        {teamMember.job && (
          <div class="text-base mb-6 text-[var(--theme-text-secondary,#6b7280)]">
            {teamMember.job}
          </div>
        )}

        <!-- 內容區塊 -->
        <div class="w-full prose prose-lg max-w-none leading-relaxed rounded-xl p-6 shadow-sm border-2 mt-4 bg-[var(--theme-card-bg,#ffffff)] border-[var(--theme-border,#e5e7eb)] text-[var(--theme-text,#1f2937)]">
          {teamMember.content ? (
            <div set:html={teamMember.content} />
          ) : (
            <p>這位成員目前沒有詳細介紹。</p>
          )}
        </div>

        <!-- 工作時間表 -->
        <div class="w-full mt-6">
          <Schedule teamMember={teamMember} />
        </div>
      </div>
    </div>
  </main>

  {validImages.length > 1 && (
    <script type="module" is:inline define:vars={{teamImages: validImages.map(img => img.image?.desktop).filter(Boolean)}}>
      document.addEventListener('DOMContentLoaded', () => {
        let currentIndex = 0;
        const imgElement = document.getElementById('carousel-img');
        const dotElements = document.querySelectorAll('#carousel-dots button');
        const thumbElements = document.querySelectorAll('#carousel-thumbs img');

        function updateCarousel() {
          if (imgElement && teamImages[currentIndex]) {
            imgElement.src = teamImages[currentIndex];
            imgElement.alt = `作品圖${currentIndex + 1}`;
          }

          // 更新指示點
          dotElements.forEach((dot, index) => {
            if (index === currentIndex) {
              dot.className = 'w-2.5 h-2.5 rounded-full transition-all duration-200 bg-[var(--color-primary-500,#3b82f6)] shadow-lg';
            } else {
              dot.className = 'w-2.5 h-2.5 rounded-full transition-all duration-200 bg-[var(--theme-card-bg,#ffffff)]/60 hover:bg-[var(--theme-card-bg,#ffffff)]/80';
            }
          });

          // 更新縮圖
          thumbElements.forEach((thumb, index) => {
            if (index === currentIndex) {
              thumb.className = 'w-20 h-20 object-cover rounded-lg border-2 cursor-pointer transition-all duration-200 shadow-sm border-[var(--color-primary-500,#3b82f6)] ring-2 ring-[var(--color-primary-200,#bfdbfe)]';
            } else {
              thumb.className = 'w-20 h-20 object-cover rounded-lg border-2 cursor-pointer transition-all duration-200 shadow-sm border-[var(--theme-border,#e5e7eb)] hover:border-[var(--theme-text-secondary,#6b7280)] hover:shadow-md';
            }
          });
        }

        window.carouselPrev = () => {
          currentIndex = (currentIndex - 1 + teamImages.length) % teamImages.length;
          updateCarousel();
        };

        window.carouselNext = () => {
          currentIndex = (currentIndex + 1) % teamImages.length;
          updateCarousel();
        };

        window.carouselThumb = (index) => {
          currentIndex = index;
          updateCarousel();
        };

        // 初始化輪播
        updateCarousel();

        // 自動輪播（可選）
        if (teamImages.length > 1) {
          setInterval(() => {
            currentIndex = (currentIndex + 1) % teamImages.length;
            updateCarousel();
          }, 5000);
        }
      });
    </script>
  )}
</Layout>