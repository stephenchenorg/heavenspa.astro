---
import { seoMeta } from '@stephenchenorg/astro/page'
import { gql, graphQLAPI } from '@/api'
import Layout from '@/layouts/Layout.astro'

export interface Article {
  id: number
  title: string
  content: string
  cover: string
  started_at: string
  ended_at?: string
  og_description?: string
  og_image?: string
  og_title?: string
  seo_body?: string
  seo_description?: string
  seo_head?: string
  seo_json_ld?: string
  seo_keyword?: string
  seo_title?: string
  updated_at: string
}

export async function getStaticPaths() {
  // 假資料 - 建立24個項目
  const articlesSeeder: Article[] = Array.from({length: 24}, (_, index) => ({
    id: index + 1,
    title: `新聞標題 ${index + 1}`,
    content: `<h2>這是新聞內容 ${index + 1}</h2><p>歡迎來到 Heaven Spa，這裡是您身心靈放鬆的理想場所。我們提供頂級的 SPA 服務，讓您在繁忙的生活中找到片刻的寧靜。</p><h3>我們的服務特色</h3><ul><li>專業認證的療程師團隊</li><li>使用頂級天然護膚產品</li><li>個人化定制護理方案</li><li>舒適優雅的環境設計</li></ul><p>我們的專業團隊精心設計了這個特別的項目，結合了傳統與現代的療程技術，確保每位客戶都能獲得個人化的服務體驗。</p>`,
    cover: [
      'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg',
      'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7female-model-having-massage-spa.jpeg',
      'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7woman-spa-center.jpeg'
    ][Math.floor(Math.random() * 3)],
    started_at: `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
    updated_at: `2024-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
    seo_title: `新聞標題 ${index + 1} - Heaven Spa`,
    seo_description: `了解更多關於新聞標題 ${index + 1} 的詳細資訊`,
    og_title: `新聞標題 ${index + 1}`,
    og_description: `Heaven Spa 最新消息：新聞標題 ${index + 1}`
  }))

  let articles: Article[] = []

  try {
    // 暫時只使用假資料，確保功能正常
    articles = articlesSeeder
    console.log('Using seeder data, total articles:', articles.length) // 調試信息
    
    /* 稍後啟用 API 調用
    // 首先嘗試獲取所有文章列表
    const articlesListData = await graphQLAPI(gql`
      query GetArticlesList {
        articles {
          data {
            id
          }
        }
      }
    `)

    const articleIds = articlesListData.articles?.data || []
    
    if (articleIds.length > 0) {
      // 為每個ID獲取詳細資料
      const articlePromises = articleIds.map(async (item: {id: number}) => {
        try {
          const articleData = await graphQLAPI(gql`
            query GetArticle($id: Int!) {
              article(id: $id) {
                id
                content
                cover
                ended_at
                og_description
                og_image
                og_title
                seo_body
                seo_description
                seo_head
                seo_json_ld
                seo_keyword
                seo_title
                started_at
                title
                updated_at
              }
            }
          `, { variables: { id: item.id } })
          
          return articleData.article
        } catch (error) {
          console.error(`Failed to fetch article ${item.id}:`, error)
          return null
        }
      })

      const articlesData = await Promise.all(articlePromises)
      articles = articlesData.filter(article => article !== null)
    }

    if (articles.length === 0) {
      articles = articlesSeeder
    }
    */
  } catch (error) {
    console.error('Failed to fetch articles data:', error)
    articles = articlesSeeder
  }

  return articles.map((article) => {
    console.log('Creating path for article:', article.id, article.title) // 調試信息
    return {
      params: { id: article.id.toString() },
      props: { article }
    }
  })
}

const { article } = Astro.props as { article?: Article }

// 如果找不到文章，創建一個預設的文章物件
const defaultArticle: Article = {
  id: 0,
  title: '文章未找到',
  content: '<p>很抱歉，您請求的文章不存在或已被移除。</p><p>請返回新聞列表頁面查看其他文章。</p>',
  cover: 'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg',
  started_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
  seo_title: '文章未找到 - Heaven Spa',
  seo_description: '很抱歉，您請求的文章不存在。',
  og_title: '文章未找到',
  og_description: '很抱歉，您請求的文章不存在。'
}

const currentArticle = article || defaultArticle

const meta = seoMeta({
  title: currentArticle.seo_title || `${currentArticle.title} - 最新消息 - Heaven Spa`,
  description: currentArticle.seo_description || currentArticle.og_description || `了解更多關於 ${currentArticle.title} 的詳細資訊`,
})
---

<Layout meta={meta}>
  <main class="pt-20 pb-16 bg-white dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- 標題區域 -->
    <div class="max-w-4xl mx-auto px-4 py-8">
      <!-- 麵包屑導航 -->
      <nav class="mb-8">
        <ol class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
          <li><a href="/" class="hover:text-primary-500 dark:hover:text-primary-400 transition-colors">首頁</a></li>
          <li><span class="text-gray-400 dark:text-gray-600">/</span></li>
          <li><a href="/news" class="hover:text-primary-500 dark:hover:text-primary-400 transition-colors">最新消息</a></li>
          <li><span class="text-gray-400 dark:text-gray-600">/</span></li>
          <li class="text-gray-800 dark:text-white truncate max-w-xs">{currentArticle.title || '新聞詳情'}</li>
        </ol>
      </nav>

      <!-- 文章標題 -->
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 dark:text-white mb-6 leading-tight transition-colors duration-300">
        {currentArticle.title || '新聞標題'}
      </h1>
      
      <!-- 發布資訊 -->
      <div class="flex flex-wrap items-center gap-4 text-gray-600 dark:text-gray-300 mb-8 transition-colors duration-300">
        <span class="text-base">
          發布時間：{new Date(currentArticle.started_at || new Date()).toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </span>
        {currentArticle.updated_at && currentArticle.updated_at !== currentArticle.started_at && (
          <span class="text-sm opacity-75">
            更新時間：{new Date(currentArticle.updated_at).toLocaleDateString('zh-TW')}
          </span>
        )}
      </div>
    </div>

    <!-- 封面圖區域 -->
    <div class="max-w-4xl mx-auto px-4 mb-8">
      <div class="relative w-full h-[400px] md:h-[500px] overflow-hidden rounded-lg shadow-lg dark:shadow-2xl transition-shadow duration-300">
        <img 
          src={currentArticle.cover || 'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg'} 
          alt={currentArticle.title || '新聞封面'}
          class="w-full h-full object-cover"
        />
      </div>
    </div>

    <!-- 內容區域 -->
    <div class="max-w-4xl mx-auto px-4">
      <!-- 文章內容 -->
      <article class="prose prose-lg prose-gray dark:prose-invert max-w-none">
        <div class="bg-gray-50 dark:bg-white/5 backdrop-blur-sm rounded-lg p-8 border border-gray-200 dark:border-white/10 shadow-sm dark:shadow-lg transition-all duration-300">
          <div class="text-gray-800 dark:text-gray-200 leading-relaxed space-y-6 transition-colors duration-300" set:html={currentArticle.content || '<p>內容載入中...</p>'}></div>
          
          <!-- SEO Body 內容 -->
          {currentArticle.seo_body && (
            <div class="mt-8 pt-8 border-t border-gray-200 dark:border-white/10 transition-colors duration-300">
              <div class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed transition-colors duration-300" set:html={currentArticle.seo_body}></div>
            </div>
          )}
        </div>
      </article>

      <!-- 行動按鈕 -->
      <div class="mt-12 flex flex-col sm:flex-row gap-4 justify-center">
        <button onclick="history.back()" 
                class="px-6 py-3 border border-gray-300 dark:border-white/30 text-gray-700 dark:text-white bg-white dark:bg-transparent rounded-lg hover:bg-gray-50 dark:hover:bg-white/10 transition-all duration-300 shadow-sm">
          返回上一頁
        </button>
        <a href="/news" 
           class="px-6 py-3 bg-primary-500 hover:bg-primary-600 dark:bg-primary-600 dark:hover:bg-primary-700 text-white rounded-lg transition-all duration-300 text-center shadow-sm">
          查看更多新聞
        </a>
        <!--<a href="/booking" -->
        <!--   class="px-6 py-3 bg-gray-900 dark:bg-white text-white dark:text-black rounded-lg hover:bg-gray-800 dark:hover:bg-gray-100 transition-all duration-300 text-center font-medium shadow-sm">-->
        <!--  立即預約-->
        <!--</a>-->
      </div>
    </div>

    <!-- 分享功能 -->
    <!--<div class="max-w-4xl mx-auto px-4 py-8">-->
    <!--  <div class="bg-gray-50 dark:bg-white/5 backdrop-blur-sm rounded-lg p-6 border border-gray-200 dark:border-white/10 shadow-sm dark:shadow-lg transition-all duration-300">-->
    <!--    <h3 class="text-gray-900 dark:text-white font-semibold mb-4 transition-colors duration-300">分享這篇文章</h3>-->
    <!--    <div class="flex gap-3">-->
    <!--      <button onclick="shareToFacebook()" -->
    <!--              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-all duration-300 text-sm shadow-sm">-->
    <!--        Facebook-->
    <!--      </button>-->
    <!--      <button onclick="shareToLine()" -->
    <!--              class="px-4 py-2 bg-green-500 hover:bg-green-600 dark:bg-green-400 dark:hover:bg-green-500 text-white rounded-lg transition-all duration-300 text-sm shadow-sm">-->
    <!--        LINE-->
    <!--      </button>-->
    <!--      <button onclick="copyLink()" -->
    <!--              class="px-4 py-2 bg-gray-600 hover:bg-gray-700 dark:bg-gray-500 dark:hover:bg-gray-600 text-white rounded-lg transition-all duration-300 text-sm shadow-sm">-->
    <!--        複製連結-->
    <!--      </button>-->
    <!--    </div>-->
    <!--  </div>-->
    <!--</div>-->
  </main>

  <script>
    function shareToFacebook() {
      const url = encodeURIComponent(window.location.href);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
    }

    function shareToLine() {
      const url = encodeURIComponent(window.location.href);
      const text = encodeURIComponent(document.title);
      window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`, '_blank');
    }

    function copyLink() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('連結已複製到剪貼簿！');
      });
    }
  </script>
</Layout>
