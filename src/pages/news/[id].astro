---
import { seoMeta } from '@stephenchenorg/astro/page'
import { gql, graphQLAPI } from '@/api'
import Layout from '@/layouts/Layout.astro'
import Prose from '@/components/ui/Prose.vue'

interface Props {
  id: string
}

interface ArticleData {
  article: {
    id: string
    title: string
    content: string
    cover: string
    ended_at?: string
    started_at?: string
  }
}

const { id } = Astro.params

if (!id || isNaN(Number(id))) {
  return Astro.rewrite('/404')
}

const articleId = parseInt(id)
console.log('Article ID:', articleId)

const data = await graphQLAPI<ArticleData>(gql`
  query GetArticle($id: Int!) {
    article(id: $id) {
      id
      title
      content
      cover
      ended_at
      started_at
    }
  }
`, { variables: { id: articleId } })

if (!data?.article) {
  return Astro.rewrite('/404')
}

const meta = seoMeta({
  title: `${data.article.title} - Heaven Spa`,
  description: data.article.content ? data.article.content.replace(/<[^>]*>/g, '').substring(0, 160) : '了解 Heaven Spa 的最新消息',
})
---

<Layout meta={meta}>
  <main class="min-h-screen">
    <!-- Hero Banner -->
    <section class="relative h-96 md:h-[500px] lg:h-[600px] overflow-hidden">
      <!-- Background Image -->
      <div class="absolute inset-0">
        <img
          src={data.article.cover || 'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg'}
          alt={data.article.title}
          class="w-full h-full object-cover"
        />
      </div>

      <!-- Content -->
      <div class="relative z-10 h-full flex items-center justify-center">
        <div class="text-center text-white px-4 max-w-4xl">
          <!-- Title -->
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold leading-tight">
            {data.article.title}
          </h1>
        </div>
      </div>
    </section>

    <!-- Article Content -->
    <section class="section-container pt-16 pb-20" style="background-color: var(--theme-bg); color: var(--theme-text);">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Breadcrumb Navigation -->
        <nav class="mb-8">
          <ol class="flex items-center space-x-2 text-sm" style="color: var(--theme-text-secondary);">
            <li><a href="/" class="transition-colors hover:underline" style="color: var(--theme-text-secondary);">首頁</a></li>
            <li><span style="color: var(--theme-text-muted);">/</span></li>
            <li><a href="/news" class="transition-colors hover:underline" style="color: var(--theme-text-secondary);">最新消息</a></li>
            <li><span style="color: var(--theme-text-muted);">/</span></li>
            <li class="truncate max-w-xs" style="color: var(--theme-text);">{data.article.title || '新聞詳情'}</li>
          </ol>
        </nav>

        <!-- Article Body -->
        <article class="mt-8">
          <Prose sourceDoc={data.article.content || ''} client:load />
        </article>

        <!-- Date Section -->
        <div class="mt-8 pt-6 border-t" style="border-color: var(--theme-border);">
          <div class="flex items-center justify-center space-x-4 text-sm md:text-base" style="color: var(--theme-text-secondary);">
            <div class="flex items-center space-x-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <span>發布日期: {new Date(data.article.started_at || new Date()).toLocaleDateString('zh-TW')}</span>
            </div>
            {data.article.ended_at && (
              <>
                <span style="color: var(--theme-text-muted);">•</span>
                <div class="flex items-center space-x-2">
                  <span>截止日期: {new Date(data.article.ended_at).toLocaleDateString('zh-TW')}</span>
                </div>
              </>
            )}
          </div>
        </div>

        <!-- Back to News Button -->
        <div class="mt-12 pt-8 border-t" style="border-color: var(--theme-border);">
          <div class="flex justify-center">
            <a
              href="/news"
              class="inline-flex items-center space-x-2 transition-colors duration-300 group px-6 py-3 text-white rounded-lg shadow-sm font-medium"
              style="background-color: var(--color-primary-500);"
            >
              <svg class="w-5 h-5 transform group-hover:-translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              <span>返回新聞列表</span>
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>
</Layout>

