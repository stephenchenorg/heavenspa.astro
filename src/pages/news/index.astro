---
import { seoMeta } from '@stephenchenorg/astro/page'
import { gql, graphQLAPI } from '@/api'
import Layout from '@/layouts/Layout.astro'
import SectionTitle from '../../components/ui/SectionTitle.astro'

export interface Article {
  id?: number
  title: string
  cover: string
  content: string
  ended_at?: string
  started_at?: string
  date?: string
  year?: string
  month?: string
}

export interface ArticlesResponse {
  articles: {
    data: Article[]
    has_more_pages: boolean
    last_page: number
    per_page: number
    to: number
    total: number
    from: number
  }
}

let articles: Article[] = []

try {
  const articlesData: ArticlesResponse = await graphQLAPI(gql`
    query MyQuery {
      articles{
        data {
          id
          content
          cover
          ended_at
          title
        }
        has_more_pages
        last_page
        per_page
        to
        total
        from
      }
    }
  `)

  // 將 API 資料轉換為 Article 格式
  const apiArticles = (articlesData.articles.data || []).map((article: Article, index: number) => {
    const createdDate = new Date()
    return {
      id: article.id || (index + 1), // 優先使用 API 的 id，否則使用 index + 1
      title: article.title,
      cover: article.cover,
      content: article.content,
      ended_at: article.ended_at,
      started_at: createdDate.toISOString(),
      date: createdDate.getDate().toString().padStart(2, '0'),
      year: createdDate.getFullYear().toString(),
      month: (createdDate.getMonth() + 1).toString().padStart(2, '0'),
    }
  })

  // 使用 API 資料
  articles = apiArticles
} catch (error) {
  console.error('Failed to fetch articles data:', error)
  // 如果 API 失敗，設定為空陣列
  articles = []
}

const meta = seoMeta({
  title: '最新消息 - Heaven Spa',
  description: '了解 Heaven Spa 的最新消息、促銷活動和健康資訊，掌握最新動態，享受專屬優惠。',
})

---

<Layout meta={meta}>
  <main class="section-container pt-32 min-h-screen">
    <!-- 標題區 -->
    <SectionTitle title="最新消息" subtitle="NEWS" />

    <div class="max-w-6xl mx-auto w-full">

      <!-- 搜尋器 (裝飾用) -->
      <!--<div class="mb-8 max-w-md mx-auto">-->
      <!--  <div class="relative">-->
      <!--    <input-->
      <!--        type="text"-->
      <!--        placeholder="搜尋新聞..."-->
      <!--        class="w-full px-4 py-3 pl-12 backdrop-blur-sm rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2"-->
      <!--        style="background-color: var(&#45;&#45;theme-card-bg); border: 1px solid var(&#45;&#45;theme-border); color: var(&#45;&#45;theme-text); focus:ring-color: var(&#45;&#45;color-primary-500); focus:border-color: var(&#45;&#45;color-primary-500);"-->
      <!--        disabled-->
      <!--    />-->
      <!--    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 transition-colors duration-300" style="color: var(&#45;&#45;theme-text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">-->
      <!--      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>-->
      <!--    </svg>-->
      <!--  </div>-->
      <!--</div>-->

      <!-- 新聞網格 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-8 w-full">
        {articles.slice(0, 12).map(article => (
          <div class="group cursor-pointer transition-all duration-300 hover:-translate-y-2 relative backdrop-blur-sm rounded-lg overflow-hidden border shadow-sm hover:shadow-lg w-full" style="background-color: var(--theme-card-bg); border-color: var(--theme-border);">
            <a href={`/news/${article.id}`} class="block">
              <!-- 上半部：封面圖 -->
              <div class="relative w-full h-60 overflow-hidden">
                <!-- Background Image -->
                <div
                  class="absolute inset-0 bg-cover bg-center"
                  style={`background-image: url('${article.cover || 'https://hamahairspa.com/wp-content/uploads/2024/06/%E5%A4%A7young-woman-lying-down-with-traditional-hot-stones-along-spi-e1719460788846.jpeg'}')`}
                >
                </div>
                <!-- Base Overlay for better text readability -->
                <div class="absolute inset-0 bg-black/20"></div>
                <!-- Hover Overlay -->
                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                <!-- VIEW MORE Button Overlay -->
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <div class="backdrop-blur-sm px-4 py-2 rounded-full text-sm font-medium transition-colors duration-200 flex items-center space-x-2 shadow-lg pointer-events-none" style="background-color: var(--theme-card-bg); color: var(--theme-text);">
                    <span>查看詳情</span>
                    <span>→</span>
                  </div>
                </div>
              </div>

              <!-- 下半部：標題和資訊 -->
              <div class="p-4 space-y-3">
                <!-- Title -->
                <div class="space-y-2">
                  <h3 class="text-lg font-bold leading-tight tracking-wide line-clamp-2 transition-colors duration-300" style="color: var(--theme-text);">
                    {article.title}
                  </h3>
                  <div class="w-12 h-0.5 rounded-full" style="background: linear-gradient(to right, var(--color-primary-500), transparent);"></div>
                </div>

                <!-- Content Summary -->
                <div class="text-sm leading-relaxed line-clamp-3 min-h-[3.6rem] transition-colors duration-300" style="color: var(--theme-text-secondary);">
                  {(() => {
                    if (!article.content) return '暫無內容摘要...'
                    // 移除 HTML 標籤
                    const textContent = article.content.replace(/<[^>]*>/g, '')
                    // 截取前50個字
                    return textContent.length > 50 ? `${textContent.substring(0, 50)}...` : textContent
                  })()}
                </div>

                <!-- Date and CTA -->
                <div class="flex items-center justify-between pt-2">
                  <div class="text-sm transition-colors duration-300" style="color: var(--theme-text-muted);">
                    <span>{new Date(article.started_at || new Date()).toLocaleDateString('zh-TW')}</span>
                  </div>
                  <div class="flex items-center space-x-1 text-sm font-medium transition-colors duration-300" style="color: var(--color-primary-500);">
                    <span>詳情</span>
                    <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </a>
          </div>
        ))}
      </div>

      <!-- 分頁器 -->
      <div class="flex justify-center items-center space-x-2">
        {Array.from({ length: Math.ceil(articles.length / 12) }, (_, i) => (
          <button
            class="px-3 py-2 rounded-lg border transition-all duration-300"
            style={i === 0
                    ? 'background-color: var(--color-primary-500); border-color: var(--color-primary-500); color: white;'
                    : 'border-color: var(--theme-border); background-color: var(--theme-card-bg); color: var(--theme-text);'}
          >
            {i + 1}
          </button>
        ))}
      </div>
    </div>

  </main>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>
